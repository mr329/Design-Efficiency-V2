<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practical Design Efficiency Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1B4F72',
                        secondary: '#D68910',
                        success: '#27AE60',
                        warning: '#F39C12',
                        danger: '#E74C3C'
                    }
                }
            }
        }
    </script>
    <style>
        .card-simple {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .card-simple:hover {
            border-color: #1B4F72;
            box-shadow: 0 4px 12px rgba(27, 79, 114, 0.15);
        }
        
        .btn-primary {
            background-color: #1B4F72;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: #154360;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #D68910;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background-color: #B7950B;
        }
        
        .status-good {
            background-color: #D5EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .status-warning {
            background-color: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEAA7;
        }
        
        .status-danger {
            background-color: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        .status-not-set {
            background-color: #F8F9FA;
            color: #6C757D;
            border: 1px solid #DEE2E6;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #27AE60 0%, #27AE60 var(--progress, 0%), #E9ECEF var(--progress, 0%), #E9ECEF 100%);
            height: 8px;
            transition: all 0.3s ease;
        }
        
        .simple-input {
            border: 2px solid #E9ECEF;
            transition: border-color 0.2s ease;
        }
        
        .simple-input:focus {
            border-color: #1B4F72;
            outline: none;
            box-shadow: 0 0 0 3px rgba(27, 79, 114, 0.1);
        }
        
        .step-nav {
            background: #F8F9FA;
            border-bottom: 3px solid #E9ECEF;
        }
        
        .step-active {
            background: #1B4F72 !important;
            color: white !important;
        }
        
        .step-completed {
            background: #27AE60 !important;
            color: white !important;
        }
        
        .parameter-card {
            border-left: 4px solid #E9ECEF;
            transition: all 0.2s ease;
        }
        
        .parameter-card.configured {
            border-left-color: #27AE60;
        }
        
        .parameter-card.warning {
            border-left-color: #F39C12;
        }
        
        .parameter-card.danger {
            border-left-color: #E74C3C;
        }
        
        .impact-simple {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .impact-low { background: #D5EDDA; color: #155724; }
        .impact-medium { background: #FFF3CD; color: #856404; }
        .impact-high { background: #F8D7DA; color: #721C24; }
        
        .section-header {
            border-bottom: 2px solid #1B4F72;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .input-mode-btn.active {
            background-color: #1B4F72 !important;
            color: white !important;
        }
        
        .simple-input-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }
        
        .dark .simple-input-card {
            background: #374151;
            border-color: #4B5563;
        }
        
        .simple-input-card:hover {
            border-color: #1B4F72;
            box-shadow: 0 4px 20px rgba(27, 79, 114, 0.1);
        }
        
        .range-display {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .range-item {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid;
        }
        
        .range-optimal {
            background: #D5EDDA;
            border-color: #C3E6CB;
            color: #155724;
        }
        
        .range-acceptable {
            background: #FFF3CD;
            border-color: #FFEAA7;
            color: #856404;
        }
        
        .range-critical {
            background: #F8D7DA;
            border-color: #F5C6CB;
            color: #721C24;
        }
        
        .dark .range-optimal {
            background: #064e3b;
            border-color: #047857;
            color: #6ee7b7;
        }
        
        .dark .range-acceptable {
            background: #78350f;
            border-color: #d97706;
            color: #fbbf24;
        }
        
        .dark .range-critical {
            background: #7f1d1d;
            border-color: #dc2626;
            color: #fca5a5;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <div class="max-w-7xl mx-auto p-4 sm:p-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transition-colors duration-300">
            <!-- Header -->
            <div class="bg-primary text-white shadow-sm">
                <div class="max-w-6xl mx-auto px-4 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-24 h-24 rounded-lg flex items-center justify-center overflow-hidden">
                                <img src="https://pfst.cf2.poecdn.net/base/image/cc880aabb5d7d2305b7aa6b910e47992b6e8a43bda688a85f93e31c5c74943f2?w=135&h=135" 
                                     alt="Practical Design Efficiency Tool" 
                                     class="w-full h-full object-contain">
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-white">Practical Design Efficiency Tool</h1>
                                <p class="text-blue-100 mt-1">Simple checks to reduce cost, speed up construction, and potentially reduce carbon emissions</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-6">
                            <!-- Status Indicators -->
                            <div class="flex items-center space-x-4 text-sm text-white">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-success rounded-full"></div>
                                    <span>Good</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-warning rounded-full"></div>
                                    <span>Review</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-danger rounded-full"></div>
                                    <span>Risk</span>
                                </div>
                            </div>
                            
                            <!-- Action Icons -->
                            <div class="flex items-center space-x-3">
                                <button 
                                    onclick="showBIMIntegration()"
                                    class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition-colors duration-300"
                                    title="BIM Integration & IFC Checks"
                                >
                                    <i data-lucide="box" class="h-5 w-5 text-white"></i>
                                </button>
                                <button 
                                    onclick="showPage('resources')"
                                    class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition-colors duration-300"
                                    title="Help & Resources"
                                >
                                    <i data-lucide="help-circle" class="h-5 w-5 text-white"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step Navigation -->
            <div class="step-nav">
                <div class="max-w-6xl mx-auto px-4 py-3">
                    <div class="flex space-x-1">
                        <button class="step-nav-btn step-active px-6 py-2 rounded-lg font-medium" onclick="showPage('input')" data-step="input">
                            1. Project Setup
                        </button>
                        <button class="step-nav-btn px-6 py-2 rounded-lg font-medium text-gray-600" onclick="showPage('analysis')" data-step="analysis">
                            2. Check Results
                        </button>
                        <button class="step-nav-btn px-6 py-2 rounded-lg font-medium text-gray-600" onclick="showPage('summary')" data-step="summary">
                            3. Summary Report
                        </button>
                        <button class="step-nav-btn px-6 py-2 rounded-lg font-medium text-gray-600" onclick="showPage('resources')" data-step="resources">
                            4. Next Steps
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page 1: Project Input -->
            <div id="inputPage" class="page active">
                <div class="p-4 sm:p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 sm:mb-0">Project Parameters Input</h2>
                            
                            <!-- Input Mode Toggle -->
                            <div class="flex items-center space-x-3 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                                <button 
                                    id="detailedInputBtn"
                                    class="input-mode-btn px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"
                                    onclick="switchInputMode('detailed')"
                                >
                                    <i data-lucide="settings" class="h-4 w-4 mr-2 inline"></i>
                                    Detailed Input
                                </button>
                                <button 
                                    id="simpleInputBtn"
                                    class="input-mode-btn px-4 py-2 rounded-md text-sm font-medium transition-colors bg-primary text-white"
                                    onclick="switchInputMode('simple')"
                                >
                                    <i data-lucide="layout-template" class="h-4 w-4 mr-2 inline"></i>
                                    Simple Input
                                </button>
                            </div>
                        </div>
                        
                        <!-- Project Info -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Project Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Project Name</label>
                                    <input type="text" id="projectName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter project name">
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Building Type</label>
                                        <div class="relative">
                                            <button 
                                                class="info-button w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white flex items-center justify-center text-xs transition-colors"
                                                onclick="toggleBuildingTypeInfo()"
                                                onmouseover="showBuildingTypeInfo()"
                                                onmouseleave="hideBuildingTypeInfo()"
                                            >
                                                <i data-lucide="info" class="h-3 w-3"></i>
                                            </button>
                                            <div id="buildingTypeInfo" class="info-popup hidden absolute z-20 left-0 top-6 w-96 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4">
                                                <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3">How Building Types Are Differentiated:</h4>
                                                <div class="space-y-3 text-xs text-gray-700 dark:text-gray-300">
                                                    <div>
                                                        <span class="font-medium text-blue-600 dark:text-blue-400">Office Buildings:</span>
                                                        <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                                            <li>Higher floor-to-floor heights (3.9m optimal) for complex MEP systems</li>
                                                            <li>Require suspended ceilings and extensive service distribution</li>
                                                            <li>Need larger cores for vertical transportation and services</li>
                                                            <li>Higher net-to-gross ratio expectations (80-85%)</li>
                                                        </ul>
                                                    </div>
                                                    <div>
                                                        <span class="font-medium text-green-600 dark:text-green-400">Residential Buildings:</span>
                                                        <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                                            <li>Lower floor-to-floor heights (3.1m optimal) with simpler MEP requirements</li>
                                                            <li>Direct service connections without extensive distribution</li>
                                                            <li>Smaller cores relative to floor area</li>
                                                            <li>Different planning efficiency considerations</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-3 italic border-t border-gray-200 dark:border-gray-600 pt-2">
                                                    💡 The tool automatically adjusts parameter guidance based on your building type selection.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <select id="buildingType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">Select building type</option>
                                        <option value="office">Office Building</option>
                                        <option value="residential">Residential</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Parameter Inputs -->
                        <div id="parameterInputs" class="space-y-4">
                            <!-- Parameter cards will be populated by JavaScript -->
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-end mt-8">
                            <button onclick="proceedToAnalysis()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors duration-300">
                                Proceed to Analysis
                                <i data-lucide="arrow-right" class="h-5 w-5 ml-2 inline"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Analysis -->
            <div id="analysisPage" class="page">
                <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 transition-colors duration-300">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex space-x-2 sm:space-x-3">
                            <button
                                id="technicalViewBtn"
                                class="view-toggle px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base bg-primary text-white"
                            >
                                Technical View
                            </button>
                            <button
                                id="quickRulesBtn"
                                class="view-toggle px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-300"
                            >
                                Quick Rules
                            </button>
                        </div>
                        <div class="flex-1 relative">
                            <div class="absolute left-3 top-3 h-5 w-5 text-gray-400">
                                <i data-lucide="search"></i>
                            </div>
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Search by rule, parameter, or category..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-300"
                            />
                        </div>
                        <select
                            id="categoryFilter"
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-colors duration-300"
                        >
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                </div>

                <!-- Quick Rules View -->
                <div id="quickRulesView" class="p-4 sm:p-6 grid gap-4">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Technical View -->
                <div id="technicalView" class="p-4 sm:p-6 hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[700px]">
                            <thead>
                                <tr class="border-b-2 border-gray-200 dark:border-gray-600">
                                    <th class="text-left p-3 text-gray-900 dark:text-gray-100">Parameter</th>
                                    <th class="text-left p-3 text-gray-900 dark:text-gray-100">Your Value</th>
                                    <th class="text-left p-3 text-gray-900 dark:text-gray-100">Status</th>
                                    <th class="text-left p-3 text-gray-900 dark:text-gray-100">Optimal</th>
                                    <th class="text-left p-3 text-gray-900 dark:text-gray-100">Action</th>
                                    <th class="text-center p-3 text-gray-900 dark:text-gray-100">Impact Scores</th>
                                </tr>
                            </thead>
                            <tbody id="technicalTableBody">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between p-4 sm:p-6 bg-gray-50 dark:bg-gray-700">
                    <button onclick="showPage('input')" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-300">
                        <i data-lucide="arrow-left" class="h-5 w-5 mr-2 inline"></i>
                        Back to Input
                    </button>
                    <button onclick="proceedToSummary()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors duration-300">
                        View Summary
                        <i data-lucide="arrow-right" class="h-5 w-5 ml-2 inline"></i>
                    </button>
                </div>
            </div>

            <!-- Page 3: Summary -->
            <div id="summaryPage" class="page">
                <div class="p-4 sm:p-6">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Project Summary & Checklist</h2>
                        
                        <!-- Project Overview -->
                        <div id="projectOverview" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                            <!-- Content will be populated by JavaScript -->
                        </div>

                        <!-- Parameter Status Grid -->
                        <div id="parameterStatusGrid" class="grid gap-4 mb-6">
                            <!-- Content will be populated by JavaScript -->
                        </div>

                        <!-- Overall Assessment -->
                        <div id="overallAssessment" class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-6 mb-6">
                            <!-- Content will be populated by JavaScript -->
                        </div>

                        <!-- Export Options -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Export Report</h3>
                            <div class="flex flex-wrap gap-4">
                                <button onclick="exportToPDF()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-300">
                                    <i data-lucide="file-text" class="h-5 w-5 mr-2 inline"></i>
                                    Export to PDF
                                </button>
                                <button onclick="exportToCSV()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-300">
                                    <i data-lucide="download" class="h-5 w-5 mr-2 inline"></i>
                                    Export to CSV
                                </button>
                                <button onclick="generatePresentation()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-300">
                                    <i data-lucide="presentation" class="h-5 w-5 mr-2 inline"></i>
                                    Generate Presentation
                                </button>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between mt-8">
                            <button onclick="showPage('analysis')" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-300">
                                <i data-lucide="arrow-left" class="h-5 w-5 mr-2 inline"></i>
                                Back to Analysis
                            </button>
                            <button onclick="showPage('resources')" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors duration-300">
                                Next Steps & Resources
                                <i data-lucide="arrow-right" class="h-5 w-5 ml-2 inline"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: Next Steps & Resources -->
            <div id="resourcesPage" class="page">
                <div class="p-4 sm:p-6">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Next Steps & Resources</h2>
                        
                        <!-- Resources Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                            
                            <!-- LECA Tool -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-6 hover:shadow-lg transition-all duration-300">
                                <div class="flex items-start gap-4">
                                    <div class="bg-green-100 dark:bg-green-900/30 rounded-lg p-3 flex-shrink-0">
                                        <i data-lucide="calculator" class="h-6 w-6 text-green-600 dark:text-green-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">LECA Tool</h3>
                                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">Lendlease Embodied Carbon Advisory tool</p>
                                        <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">Enables projects to set carbon targets at the project level during early-stage decision making.</p>
                                        <a href="https://leca.lendlease.com/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-primary hover:text-primary/80 text-sm font-medium transition-colors duration-300">
                                            Access LECA Tool
                                            <i data-lucide="external-link" class="h-4 w-4 ml-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Design Guide -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-6 hover:shadow-lg transition-all duration-300">
                                <div class="flex items-start gap-4">
                                    <div class="bg-blue-100 dark:bg-blue-900/30 rounded-lg p-3 flex-shrink-0">
                                        <i data-lucide="book-open" class="h-6 w-6 text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">Design Guide</h3>
                                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">Embodied Carbon Design Guide</p>
                                        <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">Comprehensive guidelines and best practices for reducing embodied carbon in building design.</p>
                                        <a href="https://lendlease.sharepoint.com/:b:/r/sites/KnowledgeGateway/KnowledgeLibrary/LowEmbodiedCarbonGuide_Internal_V1_Spreads_09102023094804.pdf?csf=1&web=1&e=gVUP8q" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-primary hover:text-primary/80 text-sm font-medium transition-colors duration-300">
                                            View Design Guide
                                            <i data-lucide="external-link" class="h-4 w-4 ml-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Integrated Solutions -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-6 hover:shadow-lg transition-all duration-300">
                                <div class="flex items-start gap-4">
                                    <div class="bg-purple-100 dark:bg-purple-900/30 rounded-lg p-3 flex-shrink-0">
                                        <i data-lucide="building" class="h-6 w-6 text-purple-600 dark:text-purple-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">Integrated Solutions</h3>
                                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">Lendlease Integrated Solutions</p>
                                        <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">Complete project delivery services from design to construction and beyond.</p>
                                        <a href="https://lendlease.sharepoint.com/sites/Microsite-Integrated-Solutions" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-primary hover:text-primary/80 text-sm font-medium transition-colors duration-300">
                                            Learn More
                                            <i data-lucide="external-link" class="h-4 w-4 ml-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Section -->
                        <div class="bg-gradient-to-r from-primary to-blue-600 text-white rounded-lg p-6 mb-6">
                            <div class="flex items-start gap-4">
                                <div class="bg-white/20 rounded-lg p-3 flex-shrink-0">
                                    <i data-lucide="users" class="h-8 w-8"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2">Need Expert Support?</h3>
                                    <p class="text-blue-100 mb-4">Contact Lendlease Integrated Solutions for detailed analysis and project-specific questions.</p>
                                    <div class="bg-white/10 rounded-lg p-4">
                                        <p class="text-sm text-blue-100 mb-2">Our team of experts can help you:</p>
                                        <ul class="text-sm text-blue-100 space-y-1">
                                            <li>• Conduct detailed structural and MEP analysis</li>
                                            <li>• Optimise design parameters for your specific project</li>
                                            <li>• Implement advanced efficiency strategies</li>
                                            <li>• Address complex design challenges</li>
                                        </ul>
                                    </div>
                                    <a href="https://lendlease.sharepoint.com/sites/Microsite-Integrated-Solutions">

                                        <button class="mt-4 bg-white text-primary px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors duration-300 mb-8">
                                            <i data-lucide="mail" class="h-5 w-5 mr-2 inline"></i>
                                            Contact Our Experts
                                        </button>
                                    </a>
                                </div>
                            </div>                        
                        
                        <!-- Next Steps -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Recommended Next Steps</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-medium text-gray-800 dark:text-gray-100 mb-3">For Your Current Project:</h4>
                                    <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Review and address any risk parameters identified</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Consider detailed structural and MEP analysis</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Use LECA tool for embodied carbon targets</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="check-circle" class="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Engage with specialists for complex parameters</span>
                                        </li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800 dark:text-gray-100 mb-3">For Future Projects:</h4>
                                    <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="lightbulb" class="h-4 w-4 text-yellow-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Apply efficiency principles from the start</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="lightbulb" class="h-4 w-4 text-yellow-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Study the Embodied Carbon Design Guide</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="lightbulb" class="h-4 w-4 text-yellow-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Build efficiency into your design process</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <i data-lucide="lightbulb" class="h-4 w-4 text-yellow-500 mt-0.5 flex-shrink-0"></i>
                                            <span>Consider Lendlease Integrated Solutions</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Tool Information -->
                        <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">About This Tool</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-medium text-gray-800 dark:text-gray-100 mb-2">Purpose</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">This Practical Design Efficiency Tool provides early-stage guidance to help identify opportunities for cost reduction, construction optimization, and waste minimization.</p>
                                    
                                    <h4 class="font-medium text-gray-800 dark:text-gray-100 mb-2">Limitations</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">This tool provides indicative guidance only. Detailed analysis by qualified professionals is recommended for all projects.</p>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800 dark:text-gray-100 mb-2">Best Results</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">Use this tool early in the design process when parameters can still be easily adjusted. The tool is most effective when combined with professional expertise.</p>
                                    
                                    <h4 class="font-medium text-gray-800 dark:text-gray-100 mb-2">Support</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">For questions about this tool or your analysis results, contact our team through the link above.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between mt-8">
                            <button onclick="showPage('summary')" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-300">
                                <i data-lucide="arrow-left" class="h-5 w-5 mr-2 inline"></i>
                                Back to Summary
                            </button>
                            <button onclick="resetTool()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors duration-300">
                                <i data-lucide="refresh-cw" class="h-5 w-5 mr-2 inline"></i>
                                Start New Analysis
                            </button>
                        </div>
                        
                        <!-- Tool Development Footnote -->
                        <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-600">
                            <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                                Tool developed by <a href="https://www.linkedin.com/in/mehdirobati" target="_blank" rel="noopener noreferrer" class="text-primary hover:text-primary/80 transition-colors">Dr Mehdi Robati</a> with AI assistance.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto transition-colors duration-300">
            <div class="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-600 flex justify-between items-start">
                <div class="flex-1 pr-4">
                    <h2 id="modalTitle" class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-100"></h2>
                    <p id="modalSubtitle" class="text-gray-600 dark:text-gray-400 mt-1"></p>
                </div>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors flex-shrink-0">
                    <i data-lucide="x-circle" class="h-6 w-6"></i>
                </button>
            </div>

            <div class="p-4 sm:p-6 space-y-6" id="modalContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- BIM Integration Modal -->
    <div id="bimModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto transition-colors duration-300">
            <div class="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-600 flex justify-between items-start">
                <div class="flex-1 pr-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-100">BIM Integration & IFC Checks</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Connect design efficiency analysis with your BIM workflow</p>
                </div>
                <button id="closeBimModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors flex-shrink-0">
                    <i data-lucide="x-circle" class="h-6 w-6"></i>
                </button>
            </div>

            <div class="p-4 sm:p-6 space-y-6">
                <!-- BIM Integration Overview -->
                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-blue-100 dark:bg-blue-800/50 rounded-lg p-3 flex-shrink-0">
                            <i data-lucide="box" class="h-8 w-8 text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">Automated Parameter Extraction</h3>
                            <p class="text-blue-700 dark:text-blue-300 mb-4">
                                Automatically extract design parameters from your IFC models to populate the efficiency analysis tool, 
                                eliminating manual data entry and ensuring accuracy.
                            </p>
                            <div class="bg-blue-100 dark:bg-blue-800/30 rounded p-3">
                                <p class="text-sm text-blue-800 dark:text-blue-200 font-medium mb-2">Supported BIM Software:</p>
                                <div class="flex flex-wrap gap-2">
                                    <span class="bg-white dark:bg-gray-700 px-3 py-1 rounded-full text-xs text-blue-700 dark:text-blue-300">Revit</span>
                                    <span class="bg-white dark:bg-gray-700 px-3 py-1 rounded-full text-xs text-blue-700 dark:text-blue-300">ArchiCAD</span>
                                    <span class="bg-white dark:bg-gray-700 px-3 py-1 rounded-full text-xs text-blue-700 dark:text-blue-300">Bentley AECOsim</span>
                                    <span class="bg-white dark:bg-gray-700 px-3 py-1 rounded-full text-xs text-blue-700 dark:text-blue-300">Tekla Structures</span>
                                    <span class="bg-white dark:bg-gray-700 px-3 py-1 rounded-full text-xs text-blue-700 dark:text-blue-300">IFC 2x3/4</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Implementation Details -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">API Implementation Guide</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Complete code examples for extracting efficiency parameters from IFC models</p>
                    
                    <!-- Calculation Visualizations -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-4">
                            <i data-lucide="trending-up" class="h-5 w-5 inline mr-2 text-blue-600"></i>
                            Parameter Calculation Visualizations
                        </h4>
                        
                        <!-- Form Efficiency Diagram -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border">
                                <h5 class="font-medium text-gray-800 dark:text-gray-100 mb-3">Form Efficiency Calculation</h5>
                                <div class="relative">
                                    <svg viewBox="0 0 300 200" class="w-full h-32 border rounded">
                                        <!-- Building outline -->
                                        <rect x="50" y="50" width="200" height="100" fill="none" stroke="#3B82F6" stroke-width="2"/>
                                        <!-- Perimeter arrows -->
                                        <path d="M50 45 L250 45" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                                        <path d="M250 45 L250 155" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                                        <path d="M250 160 L50 160" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                                        <path d="M45 155 L45 50" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead)"/>
                                        <!-- Area fill -->
                                        <rect x="55" y="55" width="190" height="90" fill="#10B981" fill-opacity="0.2"/>
                                        <!-- Labels -->
                                        <text x="150" y="35" text-anchor="middle" class="fill-red-600 text-xs font-medium">Perimeter (P)</text>
                                        <text x="150" y="105" text-anchor="middle" class="fill-green-600 text-xs font-medium">Area (A)</text>
                                        <!-- Arrow marker definition -->
                                        <defs>
                                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                    <div class="mt-2 text-center">
                                        <div class="text-sm font-mono bg-gray-100 dark:bg-gray-700 rounded p-2">
                                            Form Efficiency = P ÷ A
                                        </div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                            Lower values = more efficient form
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Height/Width Ratio Diagram -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border">
                                <h5 class="font-medium text-gray-800 dark:text-gray-100 mb-3">Height/Width Ratio</h5>
                                <div class="relative">
                                    <svg viewBox="0 0 300 200" class="w-full h-32 border rounded">
                                        <!-- Building outline -->
                                        <rect x="100" y="30" width="100" height="140" fill="none" stroke="#3B82F6" stroke-width="2"/>
                                        <!-- Height arrow -->
                                        <path d="M85 30 L85 170" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead2)" marker-start="url(#arrowhead2)"/>
                                        <!-- Width arrow -->
                                        <path d="M100 185 L200 185" stroke="#10B981" stroke-width="2" marker-end="url(#arrowhead3)" marker-start="url(#arrowhead3)"/>
                                        <!-- Labels -->
                                        <text x="75" y="105" text-anchor="middle" class="fill-red-600 text-xs font-medium" transform="rotate(-90, 75, 105)">Height (H)</text>
                                        <text x="150" y="195" text-anchor="middle" class="fill-green-600 text-xs font-medium">Width (W)</text>
                                        <!-- Arrow markers -->
                                        <defs>
                                            <marker id="arrowhead2" markerWidth="8" markerHeight="6" refX="4" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#EF4444"/>
                                            </marker>
                                            <marker id="arrowhead3" markerWidth="8" markerHeight="6" refX="4" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#10B981"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                    <div class="mt-2 text-center">
                                        <div class="text-sm font-mono bg-gray-100 dark:bg-gray-700 rounded p-2">
                                            H/W Ratio = Height ÷ Width
                                        </div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                            Target: &lt;7:1 for optimal structural efficiency
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cantilever Analysis Visualization -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border mb-6">
                            <h5 class="font-medium text-gray-800 dark:text-gray-100 mb-3">Cantilever Projection Analysis</h5>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <svg viewBox="0 0 400 150" class="w-full h-24 border rounded">
                                        <!-- Main structure -->
                                        <rect x="50" y="60" width="150" height="20" fill="#3B82F6" stroke="#1E40AF" stroke-width="1"/>
                                        <!-- Support column -->
                                        <rect x="190" y="60" width="20" height="60" fill="#6B7280" stroke="#374151" stroke-width="1"/>
                                        <!-- Cantilever -->
                                        <rect x="200" y="60" width="120" height="20" fill="#EF4444" stroke="#DC2626" stroke-width="1"/>
                                        <!-- Projection measurement -->
                                        <path d="M200 45 L320 45" stroke="#F59E0B" stroke-width="2" marker-end="url(#arrowhead4)" marker-start="url(#arrowhead4)"/>
                                        <text x="260" y="40" text-anchor="middle" class="fill-amber-600 text-xs font-medium">Projection Length</text>
                                        <!-- Labels -->
                                        <text x="125" y="75" text-anchor="middle" class="fill-blue-600 text-xs font-medium">Supported</text>
                                        <text x="260" y="75" text-anchor="middle" class="fill-red-600 text-xs font-medium">Cantilever</text>
                                        <text x="200" y="95" text-anchor="middle" class="fill-gray-600 text-xs font-medium">Support</text>
                                        <!-- Arrow marker -->
                                        <defs>
                                            <marker id="arrowhead4" markerWidth="8" markerHeight="6" refX="4" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#F59E0B"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                                <div class="text-sm">
                                    <div class="font-mono bg-gray-100 dark:bg-gray-700 rounded p-2 mb-2">
                                        Material Impact = Base + (Projection × 40-60%)
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">
                                        <div class="mb-1">🟢 Optimal: &lt;1.5m projection</div>
                                        <div class="mb-1">🟡 Acceptable: &lt;2.5m projection</div>
                                        <div>🔴 Risk: &gt;3.5m projection</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Column Alignment Visualization -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border mb-6">
                            <h5 class="font-medium text-gray-800 dark:text-gray-100 mb-3">Column Alignment Analysis (1.5m Eccentricity Tolerance)</h5>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <h6 class="text-sm font-medium text-green-600 mb-2">✓ Aligned Columns</h6>
                                    <svg viewBox="0 0 200 150" class="w-full h-24 border rounded">
                                        <!-- Floor levels -->
                                        <line x1="20" y1="120" x2="180" y2="120" stroke="#E5E7EB" stroke-width="1"/>
                                        <line x1="20" y1="90" x2="180" y2="90" stroke="#E5E7EB" stroke-width="1"/>
                                        <line x1="20" y1="60" x2="180" y2="60" stroke="#E5E7EB" stroke-width="1"/>
                                        <line x1="20" y1="30" x2="180" y2="30" stroke="#E5E7EB" stroke-width="1"/>
                                        <!-- Aligned columns -->
                                        <rect x="95" y="30" width="10" height="25" fill="#10B981"/>
                                        <rect x="95" y="60" width="10" height="25" fill="#10B981"/>
                                        <rect x="95" y="90" width="10" height="25" fill="#10B981"/>
                                        <!-- Tolerance zone -->
                                        <circle cx="100" cy="100" r="15" fill="none" stroke="#10B981" stroke-width="1" stroke-dasharray="2,2"/>
                                        <text x="100" y="140" text-anchor="middle" class="fill-green-600 text-xs">1.5m tolerance</text>
                                    </svg>
                                </div>
                                <div>
                                    <h6 class="text-sm font-medium text-red-600 mb-2">✗ Misaligned Columns</h6>
                                    <svg viewBox="0 0 200 150" class="w-full h-24 border rounded">
                                        <!-- Floor levels -->
                                        <line x1="20" y1="120" x2="180" y2="120" stroke="#E5E7EB" stroke-width="1"/>
                                        <line x1="20" y1="90" x2="180" y2="90" stroke="#E5E7EB" stroke-width="1"/>
                                        <line x1="20" y1="60" x2="180" y2="60" stroke="#E5E7EB" stroke-width="1"/>
                                        <line x1="20" y1="30" x2="180" y2="30" stroke="#E5E7EB" stroke-width="1"/>
                                        <!-- Misaligned columns -->
                                        <rect x="95" y="30" width="10" height="25" fill="#EF4444"/>
                                        <rect x="110" y="60" width="10" height="25" fill="#EF4444"/>
                                        <rect x="75" y="90" width="10" height="25" fill="#EF4444"/>
                                        <!-- Transfer beam -->
                                        <rect x="70" y="85" width="55" height="5" fill="#F59E0B"/>
                                        <text x="97" y="140" text-anchor="middle" class="fill-red-600 text-xs">Transfer required</text>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <div class="text-sm font-mono bg-gray-100 dark:bg-gray-700 rounded p-2">
                                    Alignment % = (Aligned Columns ÷ Total Columns) × 100
                                </div>
                            </div>
                        </div>
                        
                        <!-- Service Runs Visualization -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border">
                            <h5 class="font-medium text-gray-800 dark:text-gray-100 mb-3">Horizontal Service Runs Analysis</h5>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <svg viewBox="0 0 300 200" class="w-full h-32 border rounded">
                                        <!-- Floor plate -->
                                        <rect x="20" y="50" width="260" height="100" fill="none" stroke="#E5E7EB" stroke-width="1"/>
                                        <!-- Service core -->
                                        <rect x="40" y="70" width="40" height="60" fill="#3B82F6" stroke="#1E40AF" stroke-width="2"/>
                                        <text x="60" y="105" text-anchor="middle" class="fill-white text-xs font-medium">Core</text>
                                        <!-- Served spaces -->
                                        <rect x="120" y="70" width="30" height="25" fill="#10B981" fill-opacity="0.3" stroke="#10B981"/>
                                        <rect x="170" y="85" width="30" height="25" fill="#F59E0B" fill-opacity="0.3" stroke="#F59E0B"/>
                                        <rect x="220" y="100" width="30" height="25" fill="#EF4444" fill-opacity="0.3" stroke="#EF4444"/>
                                        <!-- Service runs -->
                                        <path d="M80 100 L135 82" stroke="#3B82F6" stroke-width="2"/>
                                        <path d="M80 100 L185 97" stroke="#3B82F6" stroke-width="2"/>
                                        <path d="M80 100 L235 112" stroke="#3B82F6" stroke-width="2"/>
                                        <!-- Distance measurements -->
                                        <path d="M80 40 L235 40" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowhead5)"/>
                                        <text x="157" y="35" text-anchor="middle" class="fill-red-600 text-xs font-medium">Max Distance</text>
                                        <!-- Labels -->
                                        <text x="135" y="90" text-anchor="middle" class="fill-green-600 text-xs">25m</text>
                                        <text x="185" y="105" text-anchor="middle" class="fill-amber-600 text-xs">35m</text>
                                        <text x="235" y="120" text-anchor="middle" class="fill-red-600 text-xs">45m</text>
                                        <!-- Arrow marker -->
                                        <defs>
                                            <marker id="arrowhead5" markerWidth="8" markerHeight="6" refX="4" refY="3" orient="auto">
                                                <polygon points="0 0, 8 3, 0 6" fill="#EF4444"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                                <div class="text-sm">
                                    <div class="font-mono bg-gray-100 dark:bg-gray-700 rounded p-2 mb-2">
                                        Max Distance = furthest_space_distance
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">
                                        <div class="mb-1">🟢 Optimal: &lt;25m from core</div>
                                        <div class="mb-1">🟡 Acceptable: 25-35m from core</div>
                                        <div class="mb-1">🔴 Risk: &gt;35m from core</div>
                                        <div class="mt-2 font-medium">Material Impact:</div>
                                        <div>Long runs require 40% larger ducts</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Efficiency Impact Chart -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border">
                            <h5 class="font-medium text-gray-800 dark:text-gray-100 mb-3">Parameter Impact Comparison</h5>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Cantilevers (per meter)</span>
                                    <div class="flex items-center">
                                        <div class="w-32 h-4 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">
                                            <div class="h-4 bg-red-500 rounded-full" style="width: 90%"></div>
                                        </div>
                                        <span class="text-xs text-red-600 font-medium">+40-60%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Transfer Structures</span>
                                    <div class="flex items-center">
                                        <div class="w-32 h-4 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">
                                            <div class="h-4 bg-red-500 rounded-full" style="width: 100%"></div>
                                        </div>
                                        <span class="text-xs text-red-600 font-medium">+200%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Long Service Runs</span>
                                    <div class="flex items-center">
                                        <div class="w-32 h-4 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">
                                            <div class="h-4 bg-yellow-500 rounded-full" style="width: 60%"></div>
                                        </div>
                                        <span class="text-xs text-yellow-600 font-medium">+40%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Poor Form Efficiency</span>
                                    <div class="flex items-center">
                                        <div class="w-32 h-4 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">
                                            <div class="h-4 bg-orange-500 rounded-full" style="width: 50%"></div>
                                        </div>
                                        <span class="text-xs text-orange-600 font-medium">+15-20%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Tall/Thin Buildings</span>
                                    <div class="flex items-center">
                                        <div class="w-32 h-4 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">
                                            <div class="h-4 bg-orange-500 rounded-full" style="width: 45%"></div>
                                        </div>
                                        <span class="text-xs text-orange-600 font-medium">+20-30%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                Material cost increases relative to optimized baseline design
                            </div>
                        </div>
                    </div>

                    <!-- Basic Form Parameters -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">
                            <i data-lucide="box" class="h-5 w-5 inline mr-2 text-blue-600"></i>
                            Basic Form & Structure Parameters
                        </h4>
                        <div class="bg-gray-900 rounded p-4 text-sm overflow-x-auto">
                            <pre class="text-green-400"><code>import ifcopenshell
import ifcopenshell.geom
from collections import defaultdict
import numpy as np

class EfficiencyParameterExtractor:
    def __init__(self, ifc_file_path):
        self.model = ifcopenshell.open(ifc_file_path)
        self.settings = ifcopenshell.geom.settings()
        
    def extract_form_efficiency(self):
        """Calculate building perimeter to area ratio"""
        # Get exterior walls
        walls = self.model.by_type('IfcWall')
        exterior_walls = [w for w in walls if self.is_exterior_wall(w)]
        
        # Calculate perimeter
        perimeter = 0
        for wall in exterior_walls:
            shape = ifcopenshell.geom.create_shape(self.settings, wall)
            perimeter += self.get_wall_length(shape)
        
        # Get total floor area
        spaces = self.model.by_type('IfcSpace')
        total_area = sum(self.get_space_area(space) for space in spaces)
        
        return {
            'perimeter': perimeter,
            'area': total_area,
            'form_efficiency': perimeter / total_area if total_area > 0 else 0
        }
    
    def extract_height_width_ratio(self):
        """Calculate building height to width ratio"""
        building = self.model.by_type('IfcBuilding')[0]
        storeys = self.model.by_type('IfcBuildingStorey')
        
        # Calculate building height
        elevations = [self.get_storey_elevation(s) for s in storeys]
        building_height = max(elevations) - min(elevations)
        
        # Calculate building footprint and max width
        building_footprint = self.get_building_footprint()
        max_width = max(building_footprint['width'], building_footprint['length'])
        
        return {
            'height': building_height,
            'width': max_width,
            'height_width_ratio': building_height / max_width if max_width > 0 else 0
        }
    
    def extract_floor_heights(self):
        """Extract floor-to-floor heights"""
        storeys = sorted(self.model.by_type('IfcBuildingStorey'), 
                        key=lambda s: self.get_storey_elevation(s))
        
        floor_heights = []
        for i in range(len(storeys) - 1):
            current_elevation = self.get_storey_elevation(storeys[i])
            next_elevation = self.get_storey_elevation(storeys[i + 1])
            floor_heights.append(next_elevation - current_elevation)
        
        return {
            'floor_heights': floor_heights,
            'average_floor_height': np.mean(floor_heights) if floor_heights else 0,
            'max_floor_height': max(floor_heights) if floor_heights else 0
        }</code></pre>
                        </div>
                    </div>

                    <!-- Cantilever Analysis -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">
                            <i data-lucide="maximize" class="h-5 w-5 inline mr-2 text-orange-600"></i>
                            Cantilever Projection Analysis
                        </h4>
                        <div class="bg-gray-900 rounded p-4 text-sm overflow-x-auto">
                            <pre class="text-green-400"><code>    def extract_cantilevers(self):
        """Identify and analyze cantilever elements - sorted high to low projection"""
        cantilevers = []
        
        # Analyze slabs for cantilevers
        slabs = self.model.by_type('IfcSlab')
        for slab in slabs:
            slab_cantilevers = self.analyze_slab_cantilevers(slab)
            cantilevers.extend(slab_cantilevers)
        
        # Analyze beams for cantilevers
        beams = self.model.by_type('IfcBeam')
        for beam in beams:
            beam_cantilevers = self.analyze_beam_cantilevers(beam)
            cantilevers.extend(beam_cantilevers)
        
        # Sort by projection length (high to low)
        cantilevers.sort(key=lambda x: x['length'], reverse=True)
        
        return {
            'cantilevers': cantilevers,
            'max_projection': max([c['length'] for c in cantilevers]) if cantilevers else 0,
            'total_cantilevers': len(cantilevers)
        }
    
    def analyze_slab_cantilevers(self, slab):
        """Analyze individual slab for cantilever projections"""
        cantilevers = []
        
        # Get slab geometry
        shape = ifcopenshell.geom.create_shape(self.settings, slab)
        slab_geometry = self.parse_geometry(shape)
        
        # Get supporting elements (columns, walls, beams)
        supports = self.get_slab_supports(slab)
        support_boundaries = self.get_support_boundaries(supports)
        
        # Find unsupported edges (cantilevers)
        for edge in slab_geometry['edges']:
            if self.is_cantilever_edge(edge, support_boundaries):
                projection_length = self.calculate_cantilever_projection(edge, support_boundaries)
                element_type = self.classify_cantilever_type(slab, edge)
                
                cantilevers.append({
                    'element': element_type,
                    'location': self.get_element_location(slab),
                    'length': projection_length,
                    'width': self.get_cantilever_width(edge),
                    'load': self.classify_cantilever_load(slab, edge),
                    'element_id': slab.GlobalId
                })
        
        return cantilevers
    
    def classify_cantilever_type(self, element, edge):
        """Classify cantilever type based on context"""
        # Check if it's a balcony (adjacent to spaces)
        if self.is_adjacent_to_residential_space(element):
            return 'Balcony'
        # Check if it's roof level
        elif self.is_roof_level(element):
            return 'Roof Overhang'
        # Check if it supports facade
        elif self.supports_facade_elements(element):
            return 'Facade Element'
        else:
            return 'Slab Extension'</code></pre>
                        </div>
                    </div>

                    <!-- Transfer Structure Analysis -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">
                            <i data-lucide="layers" class="h-5 w-5 inline mr-2 text-red-600"></i>
                            Transfer Structure Analysis
                        </h4>
                        <div class="bg-gray-900 rounded p-4 text-sm overflow-x-auto">
                            <pre class="text-green-400"><code>    def extract_transfer_structures(self):
        """Identify transfer levels - sorted by thickness (thickest to lowest)"""
        transfers = []
        
        storeys = self.model.by_type('IfcBuildingStorey')
        for storey in storeys:
            storey_transfers = self.analyze_storey_transfers(storey)
            transfers.extend(storey_transfers)
        
        # Sort by slab thickness (thickest to lowest)
        transfers.sort(key=lambda x: x['thickness'], reverse=True)
        
        return {
            'transfers': transfers,
            'transfer_count': len(transfers),
            'max_thickness': max([t['thickness'] for t in transfers]) if transfers else 0
        }
    
    def analyze_storey_transfers(self, storey):
        """Analyze individual storey for transfer structures"""
        transfers = []
        
        # Get all structural elements in this storey
        storey_elements = self.get_storey_elements(storey)
        
        # Analyze slabs for transfer characteristics
        slabs = [e for e in storey_elements if e.is_a('IfcSlab')]
        for slab in slabs:
            if self.is_transfer_slab(slab):
                transfer_data = self.analyze_transfer_slab(slab, storey)
                transfers.append(transfer_data)
        
        # Analyze beams for transfer characteristics
        beams = [e for e in storey_elements if e.is_a('IfcBeam')]
        transfer_beams = self.identify_transfer_beams(beams, storey)
        transfers.extend(transfer_beams)
        
        return transfers
    
    def is_transfer_slab(self, slab):
        """Determine if slab is a transfer structure"""
        # Check thickness (transfer slabs are typically thicker)
        thickness = self.get_slab_thickness(slab)
        if thickness > 500:  # 500mm threshold
            return True
        
        # Check if columns don't align above and below
        columns_below = self.get_columns_below_slab(slab)
        columns_above = self.get_columns_above_slab(slab)
        
        alignment_ratio = self.calculate_column_alignment(columns_below, columns_above)
        return alignment_ratio < 0.7  # Less than 70% alignment
    
    def analyze_transfer_slab(self, slab, storey):
        """Analyze transfer slab details"""
        return {
            'level': storey.Name or f"Level {storey.GlobalId[:8]}",
            'thickness': self.get_slab_thickness(slab),
            'area': self.get_slab_area(slab),
            'reason': self.determine_transfer_reason(slab),
            'structural_system': self.classify_transfer_system(slab),
            'element_id': slab.GlobalId
        }
    
    def determine_transfer_reason(self, slab):
        """Determine reason for transfer structure"""
        columns_below = self.get_columns_below_slab(slab)
        columns_above = self.get_columns_above_slab(slab)
        
        if len(columns_below) != len(columns_above):
            return 'Column Grid Change'
        elif self.has_program_change_above(slab):
            return 'Program Change'
        elif self.has_mep_constraints(slab):
            return 'MEP Requirement'
        else:
            return 'Structural Constraint'</code></pre>
                        </div>
                    </div>

                    <!-- Column Alignment Analysis -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">
                            <i data-lucide="grid-3x3" class="h-5 w-5 inline mr-2 text-purple-600"></i>
                            Column Alignment Analysis (1.5m Eccentricity Tolerance)
                        </h4>
                        <div class="bg-gray-900 rounded p-4 text-sm overflow-x-auto">
                            <pre class="text-green-400"><code>    def extract_column_alignment(self):
        """Analyze column alignment with 1.5m eccentricity tolerance"""
        columns = self.model.by_type('IfcColumn')
        column_stacks = self.group_columns_by_stack(columns)
        
        column_analysis = []
        total_columns = 0
        aligned_columns = 0
        
        for stack_id, stack_columns in column_stacks.items():
            stack_analysis = self.analyze_column_stack(stack_columns)
            column_analysis.extend(stack_analysis)
            
            total_columns += len(stack_columns)
            aligned_columns += sum(1 for col in stack_analysis if col['eccentricity'] <= 1500)
        
        # Sort by eccentricity (high to low), then by weight (heavy to light)
        column_analysis.sort(key=lambda x: (-x['eccentricity'], -x['weight']))
        
        alignment_percentage = (aligned_columns / total_columns * 100) if total_columns > 0 else 100
        
        return {
            'columns': column_analysis,
            'alignment_percentage': alignment_percentage,
            'total_columns': total_columns,
            'aligned_columns': aligned_columns
        }
    
    def analyze_column_stack(self, stack_columns):
        """Analyze alignment within a column stack"""
        # Sort by elevation
        sorted_columns = sorted(stack_columns, key=lambda c: self.get_column_elevation(c))
        
        analysis = []
        base_position = self.get_column_position(sorted_columns[0])
        
        for i, column in enumerate(sorted_columns):
            current_position = self.get_column_position(column)
            eccentricity = self.calculate_distance(base_position, current_position) * 1000  # Convert to mm
            
            column_data = {
                'column_id': column.GlobalId[:8],
                'location': self.get_column_grid_location(column),
                'size': self.get_column_size(column),
                'weight': self.calculate_column_weight(column),
                'eccentricity': eccentricity,
                'levels': self.count_column_levels(column),
                'material': self.get_column_material(column),
                'aligned': eccentricity <= 1500  # 1.5m tolerance
            }
            analysis.append(column_data)
        
        return analysis
    
    def calculate_column_weight(self, column):
        """Calculate column weight per meter"""
        # Get column dimensions
        dimensions = self.get_column_dimensions(column)
        material = self.get_column_material(column)
        
        # Material densities (kg/m³)
        densities = {
            'Concrete': 2400,
            'Steel': 7850,
            'Composite': 2200,
            'Timber': 600
        }
        
        density = densities.get(material, 2400)
        volume_per_meter = dimensions['width'] * dimensions['depth']  # m²
        
        return volume_per_meter * density</code></pre>
                        </div>
                    </div>

                    <!-- Service Runs Analysis -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">
                            <i data-lucide="git-branch" class="h-5 w-5 inline mr-2 text-green-600"></i>
                            Horizontal Service Runs Analysis
                        </h4>
                        <div class="bg-gray-900 rounded p-4 text-sm overflow-x-auto">
                            <pre class="text-green-400"><code>    def extract_service_runs(self):
        """Calculate maximum horizontal distances from service cores"""
        # Get all service cores and risers
        cores = self.identify_service_cores()
        service_analysis = []
        
        for core in cores:
            core_analysis = self.analyze_service_core(core)
            service_analysis.append(core_analysis)
        
        # Sort by maximum distance (high to low)
        service_analysis.sort(key=lambda x: x['max_distance'], reverse=True)
        
        overall_max_distance = max([s['max_distance'] for s in service_analysis]) if service_analysis else 0
        
        return {
            'service_cores': service_analysis,
            'max_service_distance': overall_max_distance,
            'core_count': len(service_analysis)
        }
    
    def identify_service_cores(self):
        """Identify service cores and risers"""
        cores = []
        
        # Look for MEP spaces
        spaces = self.model.by_type('IfcSpace')
        for space in spaces:
            if self.is_service_space(space):
                cores.append({
                    'element': space,
                    'type': self.classify_service_type(space),
                    'location': self.get_space_location(space)
                })
        
        # Look for distribution elements
        distribution_elements = self.model.by_type('IfcDistributionElement')
        for element in distribution_elements:
            if self.is_major_distribution_point(element):
                cores.append({
                    'element': element,
                    'type': self.classify_distribution_type(element),
                    'location': self.get_element_location(element)
                })
        
        return cores
    
    def analyze_service_core(self, core):
        """Analyze service reach from individual core"""
        core_position = core['location']
        served_spaces = self.get_served_spaces(core)
        
        distances = []
        total_served_area = 0
        
        for space in served_spaces:
            space_position = self.get_space_centroid(space)
            distance = self.calculate_horizontal_distance(core_position, space_position)
            distances.append(distance)
            total_served_area += self.get_space_area(space)
        
        efficiency = self.calculate_distribution_efficiency(core, served_spaces)
        
        return {
            'core_id': core['element'].GlobalId[:8],
            'core_type': core['type'],
            'location': f"{core_position['x']:.0f}, {core_position['y']:.0f}",
            'max_distance': max(distances) if distances else 0,
            'served_area': total_served_area,
            'efficiency': efficiency
        }
    
    def calculate_distribution_efficiency(self, core, served_spaces):
        """Calculate distribution efficiency based on routing complexity"""
        # Analyze routing paths
        routing_complexity = self.analyze_routing_paths(core, served_spaces)
        
        if routing_complexity < 2:
            return 'High (Direct)'
        elif routing_complexity < 4:
            return 'Medium (1-2 Branches)'
        else:
            return 'Low (Multiple Branches)'</code></pre>
                        </div>
                    </div>

                    <!-- Usage Example -->
                    <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-6">
                        <h4 class="font-semibold text-green-800 dark:text-green-200 mb-3">
                            <i data-lucide="play-circle" class="h-5 w-5 inline mr-2"></i>
                            Complete Usage Example
                        </h4>
                        <div class="bg-gray-900 rounded p-4 text-sm overflow-x-auto">
                            <pre class="text-green-400"><code># Complete extraction workflow
def extract_all_efficiency_parameters(ifc_file_path):
    """Extract all efficiency parameters from IFC model"""
    extractor = EfficiencyParameterExtractor(ifc_file_path)
    
    # Extract all parameters
    results = {
        'form_efficiency': extractor.extract_form_efficiency(),
        'height_width_ratio': extractor.extract_height_width_ratio(),
        'floor_heights': extractor.extract_floor_heights(),
        'cantilevers': extractor.extract_cantilevers(),
        'transfers': extractor.extract_transfer_structures(),
        'column_alignment': extractor.extract_column_alignment(),
        'service_runs': extractor.extract_service_runs(),
        'grid_spacing': extractor.extract_structural_grid(),
        'window_wall_ratio': extractor.extract_window_wall_ratio(),
        'net_to_gross': extractor.extract_net_to_gross_ratio()
    }
    
    # Submit to efficiency tool API
    api_payload = format_for_efficiency_tool(results)
    
    return {
        'raw_data': results,
        'formatted_payload': api_payload,
        'analysis_summary': generate_summary(results)
    }

# Example usage
if __name__ == "__main__":
    ifc_file = "path/to/your/model.ifc"
    efficiency_data = extract_all_efficiency_parameters(ifc_file)
    
    # Send to efficiency analysis tool
    response = requests.post(
        'https://mr329.github.io/Design-Efficiency-V2/api/analyze',
        json=efficiency_data['formatted_payload']
    )
    
    print("Analysis complete:", response.json())</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Get Started Section -->
                <div class="bg-gradient-to-r from-primary to-blue-600 text-white rounded-lg p-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-white/20 rounded-lg p-3 flex-shrink-0">
                            <i data-lucide="rocket" class="h-8 w-8"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Ready to Integrate?</h3>
                            <p class="text-blue-100 mb-4">Contact our development team to set up BIM integration for your workflow through Lendlease Integrated Solutions.</p>
                            <div class="flex flex-wrap gap-3">
                                <a href="https://lendlease.sharepoint.com/sites/Microsite-Integrated-Solutions" target="_blank" rel="noopener noreferrer" class="bg-white text-primary px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors duration-300 inline-flex items-center">
                                    <i data-lucide="external-link" class="h-5 w-5 mr-2"></i>
                                    Integrated Solutions
                                </a>
                                <button class="bg-white/20 text-white px-6 py-3 rounded-lg font-semibold hover:bg-white/30 transition-colors duration-300">
                                    <i data-lucide="download" class="h-5 w-5 mr-2 inline"></i>
                                    SDK Download
                                </button>
                                <button class="bg-white/20 text-white px-6 py-3 rounded-lg font-semibold hover:bg-white/30 transition-colors duration-300">
                                    <i data-lucide="mail" class="h-5 w-5 mr-2 inline"></i>
                                    Contact Support
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Application state
        let selectedParameter = null;
        let filterCategory = 'all';
        let searchTerm = '';
        let viewMode = 'decision';
        let currentPage = 'input';
        let inputMode = 'simple'; // 'detailed' or 'simple'
        
        // Project data
        let projectData = {
            name: '',
            type: '',
            parameters: {}
        };

        // Enhanced parameters data with input configurations
        const parameters = [
            {
                id: 'form-efficiency',
                category: 'Building Form',
                parameter: 'Form Efficiency',
                metric: 'P/A Ratio',
                definition: 'The ratio of exterior wall perimeter to floor area. Lower values indicate more compact, efficient forms. Calculated as: Building Perimeter (m) ÷ Floor Area (m²).',
                quickRule: 'Keep building shape simple and compact',
                optimal: '<0.25',
                acceptable: '<0.30',
                risk: '>0.30',
                benefits: ['💰 Considerable material savings', '🌿 Major energy impacts', '⏱️ Faster construction'],
                technicalNote: 'Compact building forms dramatically reduce material usage and energy consumption. A more efficient footprint can save 15-20% in structural materials and 10-15% in ongoing energy costs by minimizing the building envelope surface area.',
                action: 'Simplify building outline',
                remediation: ['Consolidate projections', 'Square off corners', 'Combine service areas', 'Use rectangular forms'],
                impactScore: { cost: 'Medium', carbon: 'High', time: 'Medium' },
                keyImpact: '+15-20% materials, +10-15% energy',
                inputType: 'calculation',
                unit: 'ratio',
                inputLabel: 'External Perimeter to Area Ratio',
                calculation: {
                    inputs: ['perimeter', 'area'],
                    labels: ['Building Perimeter (m)', 'Floor Area (m²)'],
                    formula: 'perimeter / area'
                },
                ranges: { optimal: { min: 0, max: 0.25 }, acceptable: { min: 0.25, max: 0.30 }, risk: { min: 0.30, max: 1 } },
                defaultValue: 0.28
            },
            {
                id: 'building-proportion',
                category: 'Building Form',
                parameter: 'Height/Width Ratio',
                metric: 'H/W Ratio',
                definition: 'The ratio of building height to its maximum width. Measures the slenderness of the building. Calculated as: Building Height (m) ÷ Maximum Building Width (m).',
                quickRule: 'Avoid very tall, thin buildings',
                optimal: '<7:1',
                acceptable: '<8:1',
                risk: '>8:1',
                benefits: ['💰 Reduced wind costs', '⏱️ Simpler structural build', '🌿 Material efficiency'],
                technicalNote: 'Slender buildings require increasingly expensive wind resistance systems and sophisticated structural solutions. Buildings taller than 7 times their width need specialized lateral systems that can increase structural costs by 20-30%.',
                action: 'Review massing proportions',
                remediation: ['Widen floor plate', 'Add setbacks at height', 'Use outrigger systems', 'Consider building separation'],
                impactScore: { cost: 'Medium', carbon: 'Medium', time: 'High' },
                keyImpact: '+20-30% lateral system',
                inputType: 'calculation',
                unit: ':1',
                inputLabel: 'Height ÷ Width Ratio',
                calculation: {
                    inputs: ['height', 'width'],
                    labels: ['Building Height (m)', 'Max Building Width (m)'],
                    formula: 'height / width'
                },
                ranges: { optimal: { min: 0, max: 7 }, acceptable: { min: 7, max: 8 }, risk: { min: 8, max: 20 } },
                defaultValue: 6.8
            },
            {
                id: 'structural-grid',
                category: 'Structure',
                parameter: 'Grid Spacing',
                metric: 'Bay Size',
                definition: 'The distance between structural columns, determining the span of beams and floor systems.',
                quickRule: 'Keep structural bay size around 7.5-8m',
                optimal: '7.5-8.0m',
                acceptable: '6-9m',
                risk: '>10.5m',
                benefits: ['💰 Optimal beam sizing', '⏱️ Standard construction', '🌿 Balanced materials'],
                technicalNote: 'Optimal structural bay spacing balances structural efficiency with space planning flexibility. Grids beyond 9m require significantly deeper beams, increasing material use and floor height.',
                action: 'Standardize grid at 7.5-8m',
                remediation: ['Add intermediate columns', 'Use post-tensioning', 'Accept deeper beams', 'Consider steel alternatives'],
                impactScore: { cost: 'Medium', carbon: 'High', time: 'Medium' },
                keyImpact: '+40% beam depth at 10.5m',
                inputType: 'number',
                unit: 'm',
                ranges: { optimal: { min: 7.5, max: 8.0 }, acceptable: { min: 6, max: 9 }, risk: { min: 9, max: 15 } },
                defaultValue: 7.8
            },
            {
                id: 'floor-height',
                category: 'Vertical Design',
                parameter: 'Floor-to-Floor Height',
                metric: 'F2F Height',
                definition: 'The vertical distance from finished floor to finished floor above, affecting building volume and structural requirements.',
                quickRule: 'Standard heights reduce costs considerably',
                optimal: '3.1m (res) / 3.9m (off)',
                acceptable: '3.0-3.3m / 3.6-4.2m',
                risk: '>3.6m / >4.5m',
                benefits: ['💰 Major cost savings', '⏱️ Standard formwork', '🌿 Less structrual materils'],
                technicalNote: 'Every 100mm adds one floor per 30-story building. Every 100mm of extra height adds ~2-3% to total building carbon through additional materials. Office buildings typically require higher floor-to-floor heights (3.9m) to accommodate larger MEP systems, while residential buildings can use lower heights (3.1m).',
                action: 'Minimize to functional needs',
                remediation: ['Optimize MEP zones', 'Use exposed ceilings', 'Coordinate services', 'Reduce plenum space'],
                impactScore: { cost: 'Medium', carbon: 'Medium', time: 'Low' },
                keyImpact: '+2-3% total carbon per 100mm',
                inputType: 'number',
                unit: 'm',
                buildingTypeSpecific: {
                    office: {
                        optimal: { min: 3.6, max: 3.9 },
                        acceptable: { min: 3.6, max: 4.2 },
                        risk: { min: 4.5, max: 6 },
                        note: 'Office buildings require additional height for MEP systems and suspended ceilings'
                    },
                    residential: {
                        optimal: { min: 3.0, max: 3.1 },
                        acceptable: { min: 3.0, max: 3.3 },
                        risk: { min: 3.6, max: 6 },
                        note: 'Residential buildings can use lower heights with simpler MEP requirements'
                    }
                },
                ranges: { optimal: { min: 3.0, max: 3.9 }, acceptable: { min: 3.0, max: 4.2 }, risk: { min: 4.2, max: 6 } },
                defaultValue: 3.9
            },
            {
                id: 'cantilevers',
                category: 'Special Conditions',
                parameter: 'Cantilever Projection',
                metric: 'Projection Length',
                definition: 'The distance that building elements extend beyond their primary structural support.',
                quickRule: 'Minimize or eliminate cantilevers',
                optimal: '<1.5m',
                acceptable: '<2.5m',
                risk: '>3.5m',
                benefits: ['💰 Significant material savings', '🌿 Major carbon reduction', '⏱️ Simpler construction'],
                technicalNote: 'Cantilevers have exponential material impact. Each meter of cantilever can require 40-60% more structural material in the supporting elements.',
                action: 'Minimise or eliminate',
                remediation: ['Add columns below', 'Use lightweight materials', 'Consider cable supports', 'Reduce cantilever length'],
                impactScore: { cost: 'High', carbon: 'High', time: 'High' },
                keyImpact: '+40-60% structure per metre',
                inputType: 'list',
                unit: 'm',
                inputLabel: 'Cantilever Elements',
                ranges: { optimal: { min: 0, max: 1.5 }, acceptable: { min: 1.5, max: 2.5 }, risk: { min: 3.5, max: 10 } },
                defaultValue: 0,
                listConfig: {
                    type: 'cantilevers',
                    fields: [
                        { name: 'element', label: 'Element Type', type: 'select', options: ['Balcony', 'Roof Overhang', 'Structural Beam', 'Slab Extension', 'Facade Element', 'Other'] },
                        { name: 'location', label: 'Location/Level', type: 'text' },
                        { name: 'length', label: 'Projection Length (m)', type: 'number', step: 0.1 },
                        { name: 'width', label: 'Width (m)', type: 'number', step: 0.1 },
                        { name: 'load', label: 'Load Type', type: 'select', options: ['Light (Facade only)', 'Medium (Occupied space)', 'Heavy (Structural/Equipment)'] }
                    ],
                    sortBy: 'length',
                    sortOrder: 'desc',
                    analysis: 'cantileverAnalysis'
                }
            },
            {
                id: 'transfer-structures',
                category: 'Structure',
                parameter: 'Transfer Levels',
                metric: 'Number of Transfers',
                definition: 'The number of levels where structural loads are transferred between misaligned vertical elements.',
                quickRule: 'Align vertical structure wherever possible',
                optimal: '0-1',
                acceptable: '2',
                risk: '>2',
                benefits: ['💰 Massive cost savings', '🌿 Major carbon reduction', '⏱️ Faster construction'],
                technicalNote: 'Transfers are the most carbon-intensive structural element, requiring 2-3 times the material of typical structure. They should be avoided whenever possible.',
                action: 'Align vertical structure',
                remediation: ['Relocate columns', 'Adjust program stacking', 'Accept layout constraints', 'Use steel alternatives'],
                impactScore: { cost: 'High', carbon: 'High', time: 'High' },
                keyImpact: '2-3x material at transfers',
                inputType: 'list',
                unit: 'levels',
                inputLabel: 'Transfer Slab Details',
                ranges: { optimal: { min: 0, max: 1 }, acceptable: { min: 1, max: 2 }, risk: { min: 2, max: 10 } },
                defaultValue: 0,
                listConfig: {
                    type: 'transfers',
                    fields: [
                        { name: 'level', label: 'Level/Floor', type: 'text' },
                        { name: 'thickness', label: 'Slab Thickness (mm)', type: 'number', step: 10 },
                        { name: 'area', label: 'Transfer Area (m²)', type: 'number', step: 0.1 },
                        { name: 'reason', label: 'Reason for Transfer', type: 'select', options: ['Column Grid Change', 'Program Change', 'Structural Constraint', 'MEP Requirement', 'Other'] },
                        { name: 'structural_system', label: 'Transfer System', type: 'select', options: ['Transfer Beam', 'Transfer Slab', 'Transfer Truss', 'Transfer Girder', 'Combined System'] }
                    ],
                    sortBy: 'thickness',
                    sortOrder: 'desc',
                    analysis: 'transferAnalysis'
                }
            },
            {
                id: 'window-wall-ratio',
                category: 'Envelope',
                parameter: 'Window-to-Wall Ratio',
                metric: 'WWR %',
                definition: 'The percentage of wall area occupied by windows and glazed openings.',
                quickRule: 'Balance daylight with thermal performance',
                optimal: '35-40%',
                acceptable: '30-50%',
                risk: '>60%',
                benefits: ['💰 Lower HVAC costs', '🌿 Improved energy performance', '⏱️ Simpler construction'],
                technicalNote: 'Glass has 5x the heat transfer of insulated walls. High glazing ratios increase cooling loads by 15-25% and can increase facade carbon by 40-70%.',
                action: 'Balance views with solid wall',
                remediation: ['Add spandrels', 'Use vision strips', 'Optimise by orientation', 'Add shading devices'],
                impactScore: { cost: 'High', carbon: 'Medium', time: 'Medium' },
                keyImpact: '+40-70% facade carbon at 60%',
                inputType: 'number',
                unit: '%',
                ranges: { optimal: { min: 35, max: 40 }, acceptable: { min: 30, max: 50 }, risk: { min: 60, max: 90 } },
                defaultValue: 45
            },
            {
                id: 'net-to-gross',
                category: 'Planning',
                parameter: 'Net-to-Gross Ratio',
                metric: 'NGA %',
                definition: 'The ratio of usable floor area to total floor area, indicating planning efficiency.',
                quickRule: 'Optimize core and circulation for maximum efficiency',
                optimal: '80-85% (office)',
                acceptable: '75-80%',
                risk: '<75%',
                benefits: ['💰 Direct revenue impact', '🌿 Better space utilization', '⏱️ Efficient planning'],
                technicalNote: 'Every 1% improvement in net-to-gross ratio equals 1% more revenue-generating space. Poor ratios indicate inefficient core and circulation design.',
                action: 'Optimize core and circulation',
                remediation: ['Centralize cores', 'Combine services', 'Reduce circulation', 'Optimize elevator arrangement'],
                impactScore: { cost: 'High', carbon: 'Medium', time: 'Medium' },
                keyImpact: 'Direct revenue impact',
                inputType: 'number',
                unit: '%',
                inputLabel: 'Net Gross Area/Gross Floor Area (%)',
                ranges: { optimal: { min: 80, max: 85 }, acceptable: { min: 75, max: 80 }, risk: { min: 60, max: 75 } },
                defaultValue: 78
            },
            {
                id: 'column-stacking',
                category: 'Structure',
                parameter: 'Column Alignment',
                metric: 'Stacking %',
                definition: 'The percentage of columns that stack vertically without requiring transfer structures. Based on 1.5m eccentricity tolerance across each column.',
                quickRule: 'Maintain vertical continuity of structure',
                optimal: '>85%',
                acceptable: '70-85%',
                risk: '<70%',
                benefits: ['💰 Eliminates transfer costs', '🌿 Major carbon reduction', '⏱️ Simpler construction'],
                technicalNote: 'Poor column alignment forces expensive transfer structures. Each transfer can add 200% more material locally and complicate construction significantly. Analysis based on 1.5m eccentricity tolerance.',
                action: 'Maintain vertical continuity',
                remediation: ['Adjust layouts', 'Accept program constraints', 'Add transfer beams', 'Relocate service cores'],
                impactScore: { cost: 'High', carbon: 'High', time: 'Medium' },
                keyImpact: 'Each transfer +200% local structure',
                inputType: 'list',
                unit: '%',
                inputLabel: 'Column Details & Alignment',
                ranges: { optimal: { min: 85, max: 100 }, acceptable: { min: 70, max: 85 }, risk: { min: 0, max: 70 } },
                defaultValue: 82,
                listConfig: {
                    type: 'columns',
                    fields: [
                        { name: 'column_id', label: 'Column ID', type: 'text' },
                        { name: 'location', label: 'Grid Location', type: 'text' },
                        { name: 'size', label: 'Column Size (mm)', type: 'text' },
                        { name: 'weight', label: 'Weight (kg/m)', type: 'number', step: 0.1 },
                        { name: 'eccentricity', label: 'Max Eccentricity (mm)', type: 'number', step: 1 },
                        { name: 'levels', label: 'Levels Spanned', type: 'number', step: 1 },
                        { name: 'material', label: 'Material', type: 'select', options: ['Concrete', 'Steel', 'Composite', 'Timber'] }
                    ],
                    sortBy: 'eccentricity',
                    sortOrder: 'desc',
                    analysis: 'columnAnalysis',
                    secondarySort: {
                        field: 'weight',
                        order: 'desc'
                    }
                }
            },
            {
                id: 'service-runs',
                category: 'MEP',
                parameter: 'Horizontal Service Runs',
                metric: 'Distance from Core',
                definition: 'The maximum horizontal distance from service cores to the furthest served space.',
                quickRule: 'Keep service runs short and direct',
                optimal: '<25m',
                acceptable: '25-35m',
                risk: '>35m',
                benefits: ['💰 Reduced duct sizing', '🌿 Less material usage', '⏱️ Simpler installation'],
                technicalNote: 'Long service runs need upsizing for pressure drop, increasing material use by 40% for ducts and 30% overall. They also reduce system efficiency.',
                action: 'Add risers or relocate core',
                remediation: ['Add satellite risers', 'Relocate equipment rooms', 'Use fan-powered boxes', 'Optimize core location'],
                impactScore: { cost: 'Medium', carbon: 'Medium', time: 'Medium' },
                keyImpact: '+40% duct size, +30% material',
                inputType: 'list',
                unit: 'm',
                inputLabel: 'Service Core Locations & Distances',
                ranges: { optimal: { min: 0, max: 25 }, acceptable: { min: 25, max: 35 }, risk: { min: 35, max: 100 } },
                defaultValue: 28,
                listConfig: {
                    type: 'service_runs',
                    fields: [
                        { name: 'core_id', label: 'Core/Riser ID', type: 'text' },
                        { name: 'core_type', label: 'Service Type', type: 'select', options: ['Main MEP Core', 'Secondary Riser', 'Electrical Riser', 'HVAC Equipment', 'Fire Service', 'Communication/Data'] },
                        { name: 'location', label: 'Core Location', type: 'text' },
                        { name: 'max_distance', label: 'Max Distance to Space (m)', type: 'number', step: 0.1 },
                        { name: 'served_area', label: 'Served Area (m²)', type: 'number', step: 0.1 },
                        { name: 'efficiency', label: 'Distribution Efficiency', type: 'select', options: ['High (Direct)', 'Medium (1-2 Branches)', 'Low (Multiple Branches)'] }
                    ],
                    sortBy: 'max_distance',
                    sortOrder: 'desc',
                    analysis: 'serviceRunAnalysis'
                }
            }
        ];

        // Get unique categories
        const categories = [...new Set(parameters.map(p => p.category))];

        // Initialize icons
        function initializeIcons() {
            lucide.createIcons();
        }

        // Input mode switching function
        function switchInputMode(mode) {
            inputMode = mode;
            
            // Update button states
            const detailedBtn = document.getElementById('detailedInputBtn');
            const simpleBtn = document.getElementById('simpleInputBtn');
            
            if (mode === 'detailed') {
                detailedBtn.className = 'input-mode-btn px-4 py-2 rounded-md text-sm font-medium transition-colors bg-primary text-white';
                simpleBtn.className = 'input-mode-btn px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600';
            } else {
                detailedBtn.className = 'input-mode-btn px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600';
                simpleBtn.className = 'input-mode-btn px-4 py-2 rounded-md text-sm font-medium transition-colors bg-primary text-white';
            }
            
            // Re-render the parameter inputs
            renderParameterInputs();
        }

        // Page navigation functions
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page
            document.getElementById(pageId + 'Page').classList.add('active');
            
            // Update step indicators
            updateStepIndicators(pageId);
            
            // Update current page
            currentPage = pageId;
            
            // Initialize page-specific content
            if (pageId === 'input') {
                renderParameterInputs();
            } else if (pageId === 'analysis') {
                initializeCategoryFilter();
                // Start with technical view first as requested
                viewMode = 'technical';
                renderTechnicalView();
            } else if (pageId === 'summary') {
                renderSummaryPage();
            }
            
            initializeIcons();
        }

        function updateStepIndicators(currentStep) {
            const stepOrder = ['input', 'analysis', 'summary'];
            const currentIndex = stepOrder.indexOf(currentStep);
            
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                
                if (index < currentIndex) {
                    indicator.classList.add('completed');
                } else if (index === currentIndex) {
                    indicator.classList.add('active');
                }
            });
        }

        // Input page functions
        function renderParameterInputs() {
            if (inputMode === 'simple') {
                renderSimpleParameterInputs();
            } else {
                renderDetailedParameterInputs();
            }
        }

        function renderSimpleParameterInputs() {
            const container = document.getElementById('parameterInputs');
            
            // Group parameters by category
            const categoryGroups = {
                'Architecture': parameters.filter(p => ['Building Form', 'Vertical Design', 'Envelope', 'Planning'].includes(p.category)),
                'Structure': parameters.filter(p => ['Structure', 'Special Conditions'].includes(p.category)),
                'MEP & Other': parameters.filter(p => ['MEP'].includes(p.category))
            };
            
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    ${Object.entries(categoryGroups).map(([categoryName, params]) => `
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-4">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-600">
                                ${categoryName}
                            </h3>
                            <div class="space-y-4">
                                ${params.map(param => {
                                    const currentValue = projectData.parameters[param.id]?.value || param.defaultValue;
                                    const currentStatus = projectData.parameters[param.id]?.status || 'not-considered';
                                    const isMinimized = projectData.parameters[param.id]?.minimized || false;
                                    
                                    return `
                                        <div id="param-container-${param.id}" class="space-y-2">
                                            <div class="flex items-center gap-2">
                                                <h4 class="text-sm font-medium text-gray-800 dark:text-gray-100 flex-1">${param.parameter}</h4>
                                                ${isMinimized ? `
                                                    <div class="flex items-center gap-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-xs">
                                                        <i data-lucide="eye-off" class="h-3 w-3"></i>
                                                        <span>Excluded</span>
                                                    </div>
                                                ` : ''}
                                                ${currentStatus === 'risk' ? `
                                                    <div class="flex items-center gap-1 px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-xs">
                                                        <i data-lucide="alert-triangle" class="h-3 w-3"></i>
                                                        <span>Needs Review</span>
                                                    </div>
                                                ` : ''}
                                                ${!isMinimized ? `
                                                    <button 
                                                        class="exclude-button w-4 h-4 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-red-500 hover:text-white flex items-center justify-center text-xs transition-colors"
                                                        onclick="excludeParameterFromAnalysis('${param.id}')"
                                                        title="Exclude this parameter from analysis"
                                                    >
                                                        <i data-lucide="x" class="h-3 w-3"></i>
                                                    </button>
                                                ` : `
                                                    <button 
                                                        class="include-button w-4 h-4 rounded-full bg-blue-200 dark:bg-blue-600 text-blue-600 dark:text-blue-300 hover:bg-green-500 hover:text-white flex items-center justify-center text-xs transition-colors"
                                                        onclick="includeParameterInAnalysis('${param.id}')"
                                                        title="Include this parameter back in analysis"
                                                    >
                                                        <i data-lucide="plus" class="h-3 w-3"></i>
                                                    </button>
                                                `}
                                                <div class="relative">
                                                    <button 
                                                        class="info-button w-4 h-4 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white flex items-center justify-center text-xs transition-colors"
                                                        onclick="toggleParameterInfo('simple-${param.id}')"
                                                    >
                                                        <i data-lucide="info" class="h-3 w-3"></i>
                                                    </button>
                                                    <div id="info-simple-${param.id}" class="info-popup hidden absolute z-10 right-0 top-6 w-80 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4">
                                                        <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3">${param.parameter}</h4>
                                                        
                                                        <div class="mb-3">
                                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Definition:</div>
                                                            <p class="text-xs text-gray-600 dark:text-gray-400">${param.definition}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quick Rule:</div>
                                                            <p class="text-xs text-gray-600 dark:text-gray-400">${param.quickRule}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Performance Ranges:</div>
                                                            <div class="space-y-1">
                                                                <div class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/30 rounded text-xs">
                                                                    <span class="text-green-700 dark:text-green-300 font-medium">Optimal</span>
                                                                    <span class="text-green-800 dark:text-green-200">${param.optimal}</span>
                                                                </div>
                                                                <div class="flex items-center justify-between p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded text-xs">
                                                                    <span class="text-yellow-700 dark:text-yellow-300 font-medium">Acceptable</span>
                                                                    <span class="text-yellow-800 dark:text-yellow-200">${param.acceptable}</span>
                                                                </div>
                                                                <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/30 rounded text-xs">
                                                                    <span class="text-red-700 dark:text-red-300 font-medium">Risk</span>
                                                                    <span class="text-red-800 dark:text-red-200">${param.risk}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impact Assessment:</div>
                                                            <div class="flex gap-1 mb-2">
                                                                ${createImpactIndicator(param.impactScore.cost, 'cost')}
                                                                ${createImpactIndicator(param.impactScore.time, 'time')}
                                                                ${createImpactIndicator(param.impactScore.carbon, 'carbon')}
                                                            </div>
                                                            <p class="text-xs text-gray-600 dark:text-gray-400">${param.keyImpact}</p>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Key Benefits:</div>
                                                            <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                                ${param.benefits.map(benefit => `<li>• ${benefit}</li>`).join('')}
                                                            </ul>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Why This Matters:</div>
                                                            <p class="text-xs text-gray-600 dark:text-gray-400">${param.technicalNote}</p>
                                                        </div>
                                                        
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Remediation Options:</div>
                                                            <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                                                ${param.remediation.map(remedy => `<li>• ${remedy}</li>`).join('')}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    ${currentStatus === 'risk' ? `
                                                        <button 
                                                            class="comment-button w-4 h-4 rounded-full bg-orange-200 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 hover:bg-orange-300 hover:text-orange-800 flex items-center justify-center text-xs transition-colors"
                                                            onclick="toggleParameterComment('${param.id}')"
                                                            title="Add comment for out-of-range value"
                                                        >
                                                            <i data-lucide="message-circle" class="h-3 w-3"></i>
                                                        </button>
                                                    ` : ''}
                                                    <div class="status-indicator px-2 py-1 rounded text-xs font-medium ${getSimpleStatusClass(currentStatus)} ${currentStatus === 'risk' ? 'border-2 border-red-400 shadow-md' : ''}">
                                                        ${getSimpleStatusIcon(currentStatus)}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <p class="text-xs text-gray-600 dark:text-gray-400">${param.quickRule}</p>
                                            
                                            <div id="content-${param.id}" ${isMinimized ? 'class="hidden"' : ''}>
                                                ${isMinimized ? `
                                                    <div class="mb-3 p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg">
                                                        <label class="block text-xs font-medium text-blue-800 dark:text-blue-200 mb-2">
                                                            Why was this subsection minimized?
                                                        </label>
                                                        <textarea 
                                                            id="minimize-reason-${param.id}"
                                                            rows="2"
                                                            placeholder="Enter reason for minimizing this parameter..."
                                                            class="w-full px-2 py-1 border border-blue-300 dark:border-blue-600 rounded text-xs bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                                                            onchange="updateParameterMinimizeReason('${param.id}', this.value)"
                                                        >${projectData.parameters[param.id]?.minimizeReason || ''}</textarea>
                                                    </div>
                                                ` : `
                                                    <div>
                                                        ${param.inputType === 'calculation' ? `
                                                            <div class="mb-2">
                                                                <div class="flex gap-1 mb-1">
                                                                    <button 
                                                                        type="button"
                                                                        id="mode-calculation-${param.id}"
                                                                        onclick="toggleInputMode('${param.id}', 'calculation')"
                                                                        class="flex-1 px-2 py-1 text-xs rounded bg-primary text-white"
                                                                    >
                                                                        Calculate
                                                                    </button>
                                                                    <button 
                                                                        type="button"
                                                                        id="mode-direct-${param.id}"
                                                                        onclick="toggleInputMode('${param.id}', 'direct')"
                                                                        class="flex-1 px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300"
                                                                    >
                                                                        Direct
                                                                    </button>
                                                                </div>
                                                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                                                                    ${param.id === 'form-efficiency' ? 'Ratio = Perimeter (m) ÷ Area (m²)' : 'Ratio = Height (m) ÷ Width (m)'}
                                                                </p>
                                                            </div>
                                                            
                                                            <div id="calculation-inputs-${param.id}" class="space-y-2">
                                                                <div class="grid grid-cols-2 gap-1">
                                                                    <div>
                                                                        <label class="block text-xs text-gray-700 dark:text-gray-300">${param.calculation?.labels[0] || 'Perimeter (m)'}</label>
                                                                        <input 
                                                                            type="number" 
                                                                            id="${param.calculation?.inputs[0] || 'perimeter'}-${param.id}" 
                                                                            step="0.1"
                                                                            class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-primary focus:border-transparent"
                                                                            placeholder="0"
                                                                            onchange="calculateFormEfficiency('${param.id}')"
                                                                        >
                                                                    </div>
                                                                    <div>
                                                                        <label class="block text-xs text-gray-700 dark:text-gray-300">${param.calculation?.labels[1] || 'Area (m²)'}</label>
                                                                        <input 
                                                                            type="number" 
                                                                            id="${param.calculation?.inputs[1] || 'area'}-${param.id}" 
                                                                            step="0.1"
                                                                            class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-primary focus:border-transparent"
                                                                            placeholder="0"
                                                                            onchange="calculateFormEfficiency('${param.id}')"
                                                                        >
                                                                    </div>
                                                                </div>
                                                                <div class="flex gap-1">
                                                                    <input 
                                                                        type="number" 
                                                                        id="simple-input-${param.id}" 
                                                                        value="${currentValue}"
                                                                        step="0.001"
                                                                        readonly
                                                                        class="flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-gray-100"
                                                                        placeholder="Calculated ratio"
                                                                    >
                                                                    <button 
                                                                        type="button"
                                                                        onclick="useOptimalValueSimple('${param.id}')"
                                                                        class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors text-xs font-medium whitespace-nowrap"
                                                                        title="Use optimal value"
                                                                    >
                                                                        Opt
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            <div id="direct-inputs-${param.id}" class="hidden">
                                                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                                                    Current Value ${param.unit ? '(' + param.unit + ')' : ''}
                                                                </label>
                                                                <div class="flex gap-1">
                                                                    <input 
                                                                        type="number" 
                                                                        id="direct-input-${param.id}" 
                                                                        value="${currentValue}"
                                                                        step="0.001"
                                                                        class="flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-primary focus:border-transparent"
                                                                        placeholder="Enter ratio directly"
                                                                        onchange="updateParameterValueSimple('${param.id}', this.value)"
                                                                    >
                                                                    <button 
                                                                        type="button"
                                                                        onclick="useOptimalValueSimple('${param.id}')"
                                                                        class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors text-xs font-medium whitespace-nowrap"
                                                                        title="Use optimal value"
                                                                    >
                                                                        Opt
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ` : `
                                                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                                                Current Value ${param.unit ? '(' + param.unit + ')' : ''}
                                                            </label>
                                                            <div class="flex gap-1">
                                                                <input 
                                                                    type="number" 
                                                                    id="simple-input-${param.id}" 
                                                                    value="${currentValue}"
                                                                    step="0.1"
                                                                    class="flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-primary focus:border-transparent"
                                                                    placeholder="${param.inputHelp || 'Enter value'}"
                                                                    onchange="updateParameterValueSimple('${param.id}', this.value)"
                                                                >
                                                                <button 
                                                                    type="button"
                                                                    onclick="useOptimalValueSimple('${param.id}')"
                                                                    class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors text-xs font-medium whitespace-nowrap"
                                                                    title="Use optimal value"
                                                                >
                                                                    Opt
                                                                </button>
                                                            </div>
                                                            ${param.inputHelp ? `
                                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 italic">
                                                                    ${param.inputHelp}
                                                                </p>
                                                            ` : ''}
                                                        `}
                                                    </div>
                                                `}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            initializeIcons();
        }

        // Toggle parameter minimize function
        function toggleParameterMinimize(paramId) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            
            const currentlyMinimized = projectData.parameters[paramId].minimized || false;
            projectData.parameters[paramId].minimized = !currentlyMinimized;
            
            const contentDiv = document.getElementById(`content-${paramId}`);
            const minimizeBtn = document.querySelector(`#param-container-${paramId} .minimize-button i`);
            
            if (projectData.parameters[paramId].minimized) {
                contentDiv.classList.add('hidden');
                minimizeBtn.setAttribute('data-lucide', 'maximize-2');
            } else {
                contentDiv.classList.remove('hidden');
                minimizeBtn.setAttribute('data-lucide', 'minimize-2');
            }
            
            initializeIcons();
        }

        // Update parameter minimize reason function
        function updateParameterMinimizeReason(paramId, reason) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            projectData.parameters[paramId].minimizeReason = reason;
        }

        function renderDetailedParameterInputs() {
            const container = document.getElementById('parameterInputs');
            
            container.innerHTML = parameters.map(param => {
                const currentValue = projectData.parameters[param.id]?.value || param.defaultValue;
                const currentStatus = projectData.parameters[param.id]?.status || 'not-considered';
                const isExpanded = projectData.parameters[param.id]?.expanded || false;
                const isConsidered = currentStatus !== 'not-considered';
                
                return `
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg transition-all duration-300 ${isConsidered ? 'ring-2 ring-primary/20' : ''}">
                        <!-- Parameter Header (Always Visible) -->
                        <div class="p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200" onclick="toggleParameterExpansion('${param.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3 flex-1">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="${isExpanded ? 'chevron-down' : 'chevron-right'}" class="h-5 w-5 text-gray-400 transition-transform duration-200"></i>
                                        <h3 class="text-base font-semibold text-gray-800 dark:text-gray-100">${param.parameter}</h3>
                                        <div class="relative">
                                            <button 
                                                class="info-button w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white flex items-center justify-center text-xs transition-colors"
                                                onclick="event.stopPropagation(); toggleParameterInfo('${param.id}')"
                                            >
                                                <i data-lucide="info" class="h-3 w-3"></i>
                                            </button>
                                            <div id="info-${param.id}" class="info-popup hidden absolute z-10 left-0 top-6 w-80 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4">
                                                <div class="mb-3">
                                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Definition:</div>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">${param.definition}</p>
                                                    
                                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Performance Ranges:</div>
                                                    <div class="space-y-1">
                                                        <div class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/30 rounded text-xs">
                                                            <span class="text-green-700 dark:text-green-300 font-medium">Optimal</span>
                                                            <span class="text-green-800 dark:text-green-200">${param.optimal}</span>
                                                        </div>
                                                        <div class="flex items-center justify-between p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded text-xs">
                                                            <span class="text-yellow-700 dark:text-yellow-300 font-medium">Acceptable</span>
                                                            <span class="text-yellow-800 dark:text-yellow-200">${param.acceptable}</span>
                                                        </div>
                                                        <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/30 rounded text-xs">
                                                            <span class="text-red-700 dark:text-red-300 font-medium">Risk</span>
                                                            <span class="text-red-800 dark:text-red-200">${param.risk}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impact Scores:</div>
                                                    <div class="flex space-x-1">
                                                        ${createImpactIndicator(param.impactScore.cost, 'cost')}
                                                        ${createImpactIndicator(param.impactScore.time, 'time')}
                                                        ${createImpactIndicator(param.impactScore.carbon, 'carbon')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${param.category} • ${param.quickRule}</p>
                                        ${isConsidered ? `<p class="text-sm font-medium text-primary mt-1">Value: ${currentValue}${param.unit}</p>` : ''}
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3">
                                    <div class="status-badge px-3 py-1 rounded-full text-xs font-medium ${getStatusClass(currentStatus)}">
                                        ${getStatusLabel(currentStatus)}
                                    </div>
                                    ${isConsidered ? '<i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>' : '<i data-lucide="circle" class="h-5 w-5 text-gray-300"></i>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expanded Input Section -->
                        <div id="expanded-${param.id}" class="parameter-inputs ${isExpanded ? 'block' : 'hidden'} border-t border-gray-200 dark:border-gray-600 p-4 bg-gray-50 dark:bg-gray-700">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        ${param.inputLabel || `Current Value (${param.unit})`}
                                    </label>
                                    <div class="flex space-x-2">
                                        <input 
                                            type="number" 
                                            id="input-${param.id}" 
                                            value="${currentValue}"
                                            step="0.1"
                                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent"
                                            onchange="updateParameterValue('${param.id}', this.value)"
                                        >
                                        <button 
                                            onclick="useOptimalValue('${param.id}')"
                                            class="px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors text-sm font-medium whitespace-nowrap"
                                        >
                                            Use Optimal
                                        </button>
                                    </div>
                                    ${param.inputHelp ? `
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">
                                            ${param.inputHelp}
                                        </p>
                                    ` : ''}
                                </div>
                                
                                <div>
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Key impacts:</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${param.benefits.map(benefit => `
                                            <span class="inline-block bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700 rounded-full px-3 py-1 text-xs">
                                                ${benefit}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                ${currentStatus === 'risk' || currentStatus === 'acceptable' ? `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            Reason for deviation from optimal:
                                        </label>
                                        <textarea 
                                            id="reason-${param.id}"
                                            rows="2"
                                            placeholder="Explain why this parameter deviates from optimal..."
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent"
                                            onchange="updateParameterReason('${param.id}', this.value)"
                                        >${projectData.parameters[param.id]?.reason || ''}</textarea>
                                    </div>
                                ` : ''}
                                
                                <div class="flex justify-between items-center pt-2 border-t border-gray-200 dark:border-gray-600">
                                    <button 
                                        onclick="removeParameterFromConsideration('${param.id}')"
                                        class="text-sm text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors"
                                    >
                                        <i data-lucide="x" class="h-4 w-4 inline mr-1"></i>
                                        Remove from consideration
                                    </button>
                                    <button 
                                        onclick="toggleParameterExpansion('${param.id}')"
                                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm font-medium"
                                    >
                                        Done
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            initializeIcons();
        }

        // Simple input functions
        function updateParameterValueSimple(paramId, value) {
            const param = parameters.find(p => p.id === paramId);
            const numValue = parseFloat(value);
            
            if (isNaN(numValue)) return; // Don't update with invalid values
            
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            
            projectData.parameters[paramId].value = numValue;
            projectData.parameters[paramId].status = evaluateParameterStatus(param, numValue);
            
            // Check if value is outside acceptable range and show warning
            if (projectData.parameters[paramId].status === 'risk') {
                showRangeWarning(paramId, param, numValue);
            } else {
                hideRangeWarning(paramId);
            }
            
            // Update the visual status indicator immediately
            const statusElement = document.querySelector(`#param-container-${paramId} .status-indicator`);
            if (statusElement) {
                const currentStatus = projectData.parameters[paramId].status;
                statusElement.className = `status-indicator px-2 py-1 rounded text-xs font-medium ${getSimpleStatusClass(currentStatus)} ${currentStatus === 'risk' ? 'border-2 border-red-400 shadow-md' : ''}`;
                statusElement.textContent = getSimpleStatusIcon(currentStatus);
                
                // Show/hide comment button for risk status
                const commentButton = document.querySelector(`#param-container-${paramId} .comment-button`);
                const statusContainer = statusElement.parentElement;
                
                if (currentStatus === 'risk' && !commentButton) {
                    // Add comment button for risk status
                    const newCommentButton = document.createElement('button');
                    newCommentButton.className = 'comment-button w-4 h-4 rounded-full bg-orange-200 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 hover:bg-orange-300 hover:text-orange-800 flex items-center justify-center text-xs transition-colors';
                    newCommentButton.onclick = () => toggleParameterComment(paramId);
                    newCommentButton.title = 'Add comment for out-of-range value';
                    newCommentButton.innerHTML = '<i data-lucide="message-circle" class="h-3 w-3"></i>';
                    statusContainer.insertBefore(newCommentButton, statusElement);
                    initializeIcons();
                } else if (currentStatus !== 'risk' && commentButton) {
                    // Remove comment button for non-risk status
                    commentButton.remove();
                }
            }
        }

        function useOptimalValueSimple(paramId) {
            const param = parameters.find(p => p.id === paramId);
            const optimalValue = (param.ranges.optimal.min + param.ranges.optimal.max) / 2;
            
            document.getElementById(`simple-input-${paramId}`).value = optimalValue;
            updateParameterValueSimple(paramId, optimalValue);
        }

        function toggleParameterExpansion(paramId) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            
            const isCurrentlyExpanded = projectData.parameters[paramId].expanded || false;
            const newExpandedState = !isCurrentlyExpanded;
            
            // If expanding for the first time, consider the parameter
            if (newExpandedState && projectData.parameters[paramId].status === 'not-considered') {
                const param = parameters.find(p => p.id === paramId);
                const value = projectData.parameters[paramId].value || param.defaultValue;
                projectData.parameters[paramId].status = evaluateParameterStatus(param, value);
                projectData.parameters[paramId].value = value;
            }
            
            projectData.parameters[paramId].expanded = newExpandedState;
            renderParameterInputs();
        }

        function removeParameterFromConsideration(paramId) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            
            projectData.parameters[paramId].status = 'not-considered';
            projectData.parameters[paramId].expanded = false;
            projectData.parameters[paramId].reason = '';
            
            renderParameterInputs();
        }

        function toggleParameterInfo(paramId) {
            // Hide all other info popups
            document.querySelectorAll('.info-popup').forEach(popup => {
                if (popup.id !== `info-${paramId}`) {
                    popup.classList.add('hidden');
                }
            });
            
            // Toggle current popup
            const popup = document.getElementById(`info-${paramId}`);
            popup.classList.toggle('hidden');
        }

        function updateParameterValue(paramId, value) {
            const param = parameters.find(p => p.id === paramId);
            const numValue = parseFloat(value);
            
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            
            projectData.parameters[paramId].value = numValue;
            projectData.parameters[paramId].status = evaluateParameterStatus(param, numValue);
            
            // Re-render to update status badge and reason field
            renderParameterInputs();
        }

        function toggleParameterConsideration(paramId, considered) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            
            if (considered) {
                const param = parameters.find(p => p.id === paramId);
                const value = projectData.parameters[paramId].value || param.defaultValue;
                projectData.parameters[paramId].status = evaluateParameterStatus(param, value);
            } else {
                projectData.parameters[paramId].status = 'not-considered';
            }
            
            renderParameterInputs();
        }

        function updateParameterReason(paramId, reason) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            projectData.parameters[paramId].reason = reason;
        }

        function useOptimalValue(paramId) {
            const param = parameters.find(p => p.id === paramId);
            const optimalValue = (param.ranges.optimal.min + param.ranges.optimal.max) / 2;
            
            document.getElementById(`input-${paramId}`).value = optimalValue;
            updateParameterValue(paramId, optimalValue);
        }

        function evaluateParameterStatus(param, value) {
            if (value >= param.ranges.optimal.min && value <= param.ranges.optimal.max) {
                return 'optimal';
            } else if (value >= param.ranges.acceptable.min && value <= param.ranges.acceptable.max) {
                return 'acceptable';
            } else {
                return 'risk';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'optimal': return 'status-met';
                case 'acceptable': return 'status-met';
                case 'risk': return 'status-risk';
                case 'not-considered': return 'status-not-considered';
                default: return 'status-not-considered';
            }
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'optimal': return '✓ Optimal';
                case 'acceptable': return '~ Acceptable';
                case 'risk': return '⚠ Risk';
                case 'not-considered': return '− Not Considered';
                default: return '− Not Considered';
            }
        }

        // Analysis page functions
        function proceedToAnalysis() {
            projectData.name = document.getElementById('projectName').value;
            projectData.type = document.getElementById('buildingType').value;
            showPage('analysis');
        }

        function proceedToSummary() {
            showPage('summary');
        }

        // Filter parameters
        function getFilteredParameters() {
            return parameters.filter(p => {
                const matchesCategory = filterCategory === 'all' || p.category === filterCategory;
                const matchesSearch = 
                    p.parameter.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.category.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.quickRule.toLowerCase().includes(searchTerm.toLowerCase());
                return matchesCategory && matchesSearch;
            });
        }

        // Get score colour classes for qualitative ratings
        function getScoreColour(score) {
            if (score === 'High') return 'text-red-600 bg-red-50 dark:text-red-400 dark:bg-red-900/30';
            if (score === 'Medium') return 'text-yellow-600 bg-yellow-50 dark:text-yellow-400 dark:bg-yellow-900/30';
            return 'text-green-600 bg-green-50 dark:text-green-400 dark:bg-green-900/30';
        }

        // Create impact indicator
        function createImpactIndicator(score, type) {
            const icons = {
                cost: 'dollar-sign',
                carbon: 'leaf',
                time: 'clock'
            };
            
            return `
                <div class="impact-indicator flex items-center px-2 py-1 rounded-full ${getScoreColour(score)}">
                    <i data-lucide="${icons[type]}" class="h-4 w-4"></i>
                    <span class="ml-1 text-xs font-semibold">${score}</span>
                </div>
            `;
        }

        // Render quick rules view
        function renderQuickRulesView() {
            const container = document.getElementById('quickRulesView');
            const filteredParams = getFilteredParameters();
            
            if (filteredParams.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="search" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-400">No parameters match your search criteria.</p>
                    </div>
                `;
                initializeIcons();
                return;
            }
            
            container.innerHTML = filteredParams.map(param => {
                const paramData = projectData.parameters[param.id];
                const status = paramData?.status || 'not-considered';
                const statusIcon = status === 'optimal' ? '✅' : status === 'acceptable' ? '⚠️' : status === 'risk' ? '❌' : '➖';
                
                return `
                    <div class="card-hover bg-gray-50 dark:bg-gray-700 rounded-lg p-4 sm:p-5 cursor-pointer transition-colors duration-300"
                         onclick="showParameterDetail('${param.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 pr-4">
                                <div class="flex items-center mb-2">
                                    <span class="text-lg mr-2">${statusIcon}</span>
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">${param.quickRule}</h3>
                                    <div class="relative ml-2">
                                        <button 
                                            class="info-button w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white flex items-center justify-center text-xs transition-colors"
                                            onclick="event.stopPropagation(); toggleParameterInfo('quick-${param.id}')"
                                        >
                                            <i data-lucide="info" class="h-3 w-3"></i>
                                        </button>
                                        <div id="info-quick-${param.id}" class="info-popup hidden absolute z-10 left-0 top-6 w-80 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4">
                                            <div class="mb-3">
                                                <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Definition:</div>
                                                <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">${param.definition}</p>
                                                
                                                <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Performance Ranges:</div>
                                                <div class="space-y-1">
                                                    <div class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/30 rounded text-xs">
                                                        <span class="text-green-700 dark:text-green-300 font-medium">Optimal</span>
                                                        <span class="text-green-800 dark:text-green-200">${param.optimal}</span>
                                                    </div>
                                                    <div class="flex items-center justify-between p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded text-xs">
                                                        <span class="text-yellow-700 dark:text-yellow-300 font-medium">Acceptable</span>
                                                        <span class="text-yellow-800 dark:text-yellow-200">${param.acceptable}</span>
                                                    </div>
                                                    <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/30 rounded text-xs">
                                                        <span class="text-red-700 dark:text-red-300 font-medium">Risk</span>
                                                        <span class="text-red-800 dark:text-red-200">${param.risk}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impact Scores:</div>
                                                <div class="flex space-x-1">
                                                    ${createImpactIndicator(param.impactScore.cost, 'cost')}
                                                    ${createImpactIndicator(param.impactScore.time, 'time')}
                                                    ${createImpactIndicator(param.impactScore.carbon, 'carbon')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${param.parameter} • ${param.category}</p>
                                ${paramData?.value ? `
                                    <p class="text-sm font-medium text-primary mb-2">Your value: ${paramData.value}${param.unit}</p>
                                ` : ''}
                                <div>
                                    <div class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Key impacts:</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${param.benefits.map(benefit => `
                                            <span class="inline-block bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-full px-3 py-1 text-xs text-gray-700 dark:text-gray-200">
                                                ${benefit}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="h-5 w-5 text-gray-400 flex-shrink-0"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            initializeIcons();
        }

        // Render technical view
        function renderTechnicalView() {
            const tbody = document.getElementById('technicalTableBody');
            const filteredParams = getFilteredParameters();
            
            tbody.innerHTML = filteredParams.map(param => {
                const paramData = projectData.parameters[param.id];
                const value = paramData?.value || param.defaultValue;
                const status = paramData?.status || 'not-considered';
                
                return `
                    <tr class="border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-300">
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <div>
                                    <p class="font-medium text-gray-900 dark:text-gray-100">${param.parameter}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${param.category}</p>
                                </div>
                                <div class="relative">
                                    <button 
                                        class="info-button w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white flex items-center justify-center text-xs transition-colors"
                                        onclick="toggleParameterInfo('tech-${param.id}')"
                                    >
                                        <i data-lucide="info" class="h-3 w-3"></i>
                                    </button>
                                    <div id="info-tech-${param.id}" class="info-popup hidden absolute z-10 left-0 top-6 w-80 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4">
                                        <div class="mb-3">
                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Definition:</div>
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">${param.definition}</p>
                                            
                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Performance Ranges:</div>
                                            <div class="space-y-1">
                                                <div class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/30 rounded text-xs">
                                                    <span class="text-green-700 dark:text-green-300 font-medium">Optimal</span>
                                                    <span class="text-green-800 dark:text-green-200">${param.optimal}</span>
                                                </div>
                                                <div class="flex items-center justify-between p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded text-xs">
                                                    <span class="text-yellow-700 dark:text-yellow-300 font-medium">Acceptable</span>
                                                    <span class="text-yellow-800 dark:text-yellow-200">${param.acceptable}</span>
                                                </div>
                                                <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/30 rounded text-xs">
                                                    <span class="text-red-700 dark:text-red-300 font-medium">Risk</span>
                                                    <span class="text-red-800 dark:text-red-200">${param.risk}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impact Scores:</div>
                                            <div class="flex space-x-1">
                                                ${createImpactIndicator(param.impactScore.cost, 'cost')}
                                                ${createImpactIndicator(param.impactScore.time, 'time')}
                                                ${createImpactIndicator(param.impactScore.carbon, 'carbon')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="p-3">
                            <span class="font-semibold">${value}${param.unit}</span>
                        </td>
                        <td class="p-3">
                            <span class="status-badge px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(status)}">
                                ${getStatusLabel(status)}
                            </span>
                        </td>
                        <td class="p-3 text-green-600 dark:text-green-400 font-semibold">${param.optimal}</td>
                        <td class="p-3 text-primary font-medium">${param.action}</td>
                        <td class="p-3">
                            <div class="flex justify-center space-x-1">
                                ${createImpactIndicator(param.impactScore.cost, 'cost')}
                                ${createImpactIndicator(param.impactScore.time, 'time')}
                                ${createImpactIndicator(param.impactScore.carbon, 'carbon')}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            initializeIcons();
        }

        // Summary page functions
        function renderSummaryPage() {
            renderProjectOverview();
            renderParameterStatusGrid();
            renderOverallAssessment();
        }

        function renderProjectOverview() {
            const container = document.getElementById('projectOverview');
            const totalParams = parameters.length;
            const consideredParams = Object.values(projectData.parameters).filter(p => p.status !== 'not-considered').length;
            const optimalParams = Object.values(projectData.parameters).filter(p => p.status === 'optimal').length;
            const riskParams = Object.values(projectData.parameters).filter(p => p.status === 'risk').length;
            
            container.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Project Overview</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-800 dark:text-gray-100">${projectData.name || 'Unnamed Project'}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${projectData.type || 'Building Type'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-primary">${consideredParams}/${totalParams}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Parameters Considered</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">${optimalParams}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Optimal Parameters</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-600">${riskParams}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Risk Parameters</div>
                    </div>
                </div>
            `;
        }

        function renderParameterStatusGrid() {
            const container = document.getElementById('parameterStatusGrid');
            
            container.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Parameter Checklist</h3>
                    <div class="space-y-4">
                        ${parameters.map(param => {
                            const paramData = projectData.parameters[param.id];
                            const value = paramData?.value || param.defaultValue;
                            const status = paramData?.status || 'not-considered';
                            const reason = paramData?.reason || '';
                            
                            return `
                                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <span class="text-lg mr-3">${status === 'optimal' ? '✅' : status === 'acceptable' ? '⚠️' : status === 'risk' ? '❌' : '➖'}</span>
                                            <div>
                                                <h4 class="font-medium text-gray-800 dark:text-gray-100">${param.parameter}</h4>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">${param.category}</p>
                                            </div>
                                            <div class="relative ml-2">
                                                <button 
                                                    class="info-button w-5 h-5 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-primary hover:text-white flex items-center justify-center text-xs transition-colors"
                                                    onclick="toggleParameterInfo('summary-${param.id}')"
                                                >
                                                    <i data-lucide="info" class="h-3 w-3"></i>
                                                </button>
                                                <div id="info-summary-${param.id}" class="info-popup hidden absolute z-10 left-0 top-6 w-80 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-4">
                                                    <div class="mb-3">
                                                        <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Definition:</div>
                                                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">${param.definition}</p>
                                                        
                                                        <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Performance Ranges:</div>
                                                        <div class="space-y-1">
                                                            <div class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/30 rounded text-xs">
                                                                <span class="text-green-700 dark:text-green-300 font-medium">Optimal</span>
                                                                <span class="text-green-800 dark:text-green-200">${param.optimal}</span>
                                                            </div>
                                                            <div class="flex items-center justify-between p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded text-xs">
                                                                <span class="text-yellow-700 dark:text-yellow-300 font-medium">Acceptable</span>
                                                                <span class="text-yellow-800 dark:text-yellow-200">${param.acceptable}</span>
                                                            </div>
                                                            <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/30 rounded text-xs">
                                                                <span class="text-red-700 dark:text-red-300 font-medium">Risk</span>
                                                                <span class="text-red-800 dark:text-red-200">${param.risk}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impact Scores:</div>
                                                        <div class="flex space-x-1">
                                                            ${createImpactIndicator(param.impactScore.cost, 'cost')}
                                                            ${createImpactIndicator(param.impactScore.time, 'time')}
                                                            ${createImpactIndicator(param.impactScore.carbon, 'carbon')}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-semibold text-gray-800 dark:text-gray-100">${value}${param.unit}</div>
                                            <span class="status-badge px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(status)}">
                                                ${getStatusLabel(status)}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    ${status === 'risk' || status === 'acceptable' ? `
                                        <div class="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded">
                                            <div class="text-sm font-medium text-yellow-800 dark:text-yellow-200 mb-1">Reason for deviation:</div>
                                            <div class="text-sm text-yellow-700 dark:text-yellow-300">${reason || 'No reason provided'}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${status === 'not-considered' ? `
                                        <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-700 rounded">
                                            <div class="text-sm text-gray-600 dark:text-gray-400">This parameter was not considered in the analysis.</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderOverallAssessment() {
            const container = document.getElementById('overallAssessment');
            const totalParams = parameters.length;
            const consideredParams = Object.values(projectData.parameters).filter(p => p.status !== 'not-considered').length;
            const optimalParams = Object.values(projectData.parameters).filter(p => p.status === 'optimal').length;
            const riskParams = Object.values(projectData.parameters).filter(p => p.status === 'risk').length;
            
            const completionRate = Math.round((consideredParams / totalParams) * 100);
            const optimizationRate = consideredParams > 0 ? Math.round((optimalParams / consideredParams) * 100) : 0;
            
            // Check if all parameters are considered
            const allParametersConsidered = consideredParams === totalParams;
            
            if (!allParametersConsidered) {
                // Show only recommendations when not all parameters are provided
                const missingParams = totalParams - consideredParams;
                const missingParamsList = parameters
                    .filter(param => !projectData.parameters[param.id] || projectData.parameters[param.id].status === 'not-considered')
                    .map(param => param.parameter);
                
                container.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Analysis Status</h3>
                    <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-lg p-6">
                        <div class="flex items-start gap-3">
                            <i data-lucide="alert-triangle" class="h-6 w-6 text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Incomplete Analysis</h4>
                                <p class="text-yellow-700 dark:text-yellow-300 mb-4">
                                    You have analyzed ${consideredParams} out of ${totalParams} parameters (${completionRate}%). 
                                    Please consider the remaining ${missingParams} parameter${missingParams > 1 ? 's' : ''} for a complete assessment.
                                </p>
                                
                                <div class="mb-4">
                                    <h5 class="font-medium text-yellow-800 dark:text-yellow-200 mb-2">Missing Parameters:</h5>
                                    <ul class="list-disc list-inside text-sm text-yellow-700 dark:text-yellow-300 space-y-1">
                                        ${missingParamsList.map(param => `<li>${param}</li>`).join('')}
                                    </ul>
                                </div>
                                
                                <div class="bg-yellow-100 dark:bg-yellow-800/30 rounded p-3">
                                    <h5 class="font-medium text-yellow-800 dark:text-yellow-200 mb-2">Recommendations:</h5>
                                    <ul class="text-sm text-yellow-700 dark:text-yellow-300 space-y-1">
                                        <li>• Complete all parameter inputs for comprehensive analysis</li>
                                        <li>• Focus on high-impact parameters (cost and carbon scores)</li>
                                        <li>• Consider project-specific constraints when setting values</li>
                                        <li>• Review parameter definitions using the info (ℹ️) icons if needed</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Show full assessment when all parameters are provided
                let overallGrade, gradeColor, recommendation;
                
                if (optimizationRate >= 80 && riskParams === 0) {
                    overallGrade = 'Acceptable - Subject to Detailed Analysis';
                    gradeColor = 'text-green-600';
                    recommendation = 'Your design demonstrates good efficiency principles. Consider detailed structural and MEP analysis to confirm performance.';
                } else if (optimizationRate >= 60 && riskParams <= 1) {
                    overallGrade = 'Review Required';
                    gradeColor = 'text-blue-600';
                    recommendation = 'Some efficiency foundations in place. Detailed analysis required for optimization and risk mitigation.';
                } else if (optimizationRate >= 40 || riskParams <= 2) {
                    overallGrade = 'Redesign Recommended';
                    gradeColor = 'text-yellow-600';
                    recommendation = 'Significant improvements needed. Focus on addressing risk parameters and redesigning key elements.';
                } else {
                    overallGrade = 'Major Revision Required';
                    gradeColor = 'text-red-600';
                    recommendation = 'Comprehensive redesign required. Multiple efficiency opportunities need to be addressed.';
                }
                
                // Determine completeness qualitatively based on provided information
                let completenessQuality = '';
                let completenessColor = '';
                
                if (consideredParams >= 8) {
                    completenessQuality = 'Comprehensive';
                    completenessColor = 'text-green-600';
                } else if (consideredParams >= 6) {
                    completenessQuality = 'Good';
                    completenessColor = 'text-blue-600';
                } else if (consideredParams >= 4) {
                    completenessQuality = 'Partial';
                    completenessColor = 'text-yellow-600';
                } else {
                    completenessQuality = 'Limited';
                    completenessColor = 'text-red-600';
                }
                
                container.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Overall Assessment</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold ${gradeColor} mb-2">${overallGrade}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Overall Grade</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold ${completenessColor} mb-2">${completenessQuality}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Analysis Completeness</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600 mb-2">${optimalParams}/${consideredParams}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Optimal Parameters</div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Assessment Summary</h4>
                        <p class="text-blue-700 dark:text-blue-300">${recommendation}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs text-gray-600 dark:text-gray-400">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded p-3">
                            <strong>Overall Grade:</strong> Professional assessment based on parameter optimization and risk factors
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded p-3">
                            <strong>Analysis Completeness:</strong> Quality assessment based on number and variety of parameters provided
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded p-3">
                            <strong>Optimal Parameters:</strong> Number of parameters achieving optimal performance out of total analyzed
                        </div>
                    </div>
                `;
            }
            
            initializeIcons();
        }

        // Export functions
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Design Efficiency Analysis Report', 20, 30);
            
            // Project info
            doc.setFontSize(12);
            doc.text(`Project: ${projectData.name || 'Unnamed Project'}`, 20, 50);
            doc.text(`Building Type: ${projectData.type || 'Not specified'}`, 20, 60);
            doc.text(`Analysis Date: ${new Date().toLocaleDateString()}`, 20, 70);
            
            // Parameters summary
            let yPosition = 90;
            doc.setFontSize(14);
            doc.text('Parameter Analysis Summary', 20, yPosition);
            yPosition += 20;
            
            doc.setFontSize(10);
            parameters.forEach(param => {
                const paramData = projectData.parameters[param.id];
                const value = paramData?.value || param.defaultValue;
                const status = paramData?.status || 'not-considered';
                const reason = paramData?.reason || '';
                
                doc.text(`${param.parameter}: ${value}${param.unit} - ${getStatusLabel(status)}`, 20, yPosition);
                yPosition += 10;
                
                if (reason && yPosition < 280) {
                    doc.text(`  Reason: ${reason}`, 25, yPosition);
                    yPosition += 10;
                }
                
                if (yPosition > 280) {
                    doc.addPage();
                    yPosition = 30;
                }
            });
            
            doc.save(`design-efficiency-report-${Date.now()}.pdf`);
        }

        function exportToCSV() {
            const data = parameters.map(param => {
                const paramData = projectData.parameters[param.id];
                return {
                    Parameter: param.parameter,
                    Category: param.category,
                    'Current Value': paramData?.value || param.defaultValue,
                    Unit: param.unit,
                    Status: paramData?.status || 'not-considered',
                    'Optimal Range': param.optimal,
                    'Action Required': param.action,
                    'Reason for Deviation': paramData?.reason || '',
                    'Cost Impact': param.impactScore.cost,
                    'Time Impact': param.impactScore.time,
                    'Carbon Impact': param.impactScore.carbon
                };
            });
            
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `design-efficiency-analysis-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generatePresentation() {
            // Create a simple HTML presentation that can be saved
            const presentationContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Design Efficiency Presentation</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .slide { page-break-after: always; margin-bottom: 40px; }
                        h1 { color: #5D5CDE; border-bottom: 3px solid #5D5CDE; padding-bottom: 10px; }
                        h2 { color: #333; margin-top: 30px; }
                        .status-optimal { color: green; font-weight: bold; }
                        .status-risk { color: red; font-weight: bold; }
                        .status-acceptable { color: orange; font-weight: bold; }
                        .status-not-considered { color: gray; }
                        .parameter { margin: 20px 0; padding: 15px; border-left: 4px solid #5D5CDE; background: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <div class="slide">
                        <h1>Design Efficiency Analysis</h1>
                        <h2>Project Overview</h2>
                        <p><strong>Project:</strong> ${projectData.name || 'Unnamed Project'}</p>
                        <p><strong>Building Type:</strong> ${projectData.type || 'Not specified'}</p>
                        <p><strong>Analysis Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="slide">
                        <h1>Parameter Analysis</h1>
                        ${parameters.map(param => {
                            const paramData = projectData.parameters[param.id];
                            const value = paramData?.value || param.defaultValue;
                            const status = paramData?.status || 'not-considered';
                            const reason = paramData?.reason || '';
                            
                            return `
                                <div class="parameter">
                                    <h3>${param.parameter}</h3>
                                    <p><strong>Current Value:</strong> ${value}${param.unit}</p>
                                    <p><strong>Status:</strong> <span class="status-${status}">${getStatusLabel(status)}</span></p>
                                    <p><strong>Optimal Range:</strong> ${param.optimal}</p>
                                    ${reason ? `<p><strong>Reason for Deviation:</strong> ${reason}</p>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([presentationContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `design-efficiency-presentation-${Date.now()}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetTool() {
            projectData = { name: '', type: '', parameters: {} };
            showPage('input');
            document.getElementById('projectName').value = '';
            document.getElementById('buildingType').value = '';
        }

        // Show parameter detail modal
        function showParameterDetail(paramId) {
            const param = parameters.find(p => p.id === paramId);
            if (!param) return;
            
            selectedParameter = param;
            const paramData = projectData.parameters[param.id];
            
            document.getElementById('modalTitle').textContent = param.quickRule;
            document.getElementById('modalSubtitle').textContent = `${param.parameter} • ${param.category}`;
            
            document.getElementById('modalContent').innerHTML = `
                ${paramData ? `
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                        <p class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-1">Your Project Status</p>
                        <div class="flex items-center justify-between">
                            <span>Current Value: <strong>${paramData.value || param.defaultValue}${param.unit}</strong></span>
                            <span class="status-badge px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(paramData.status || 'not-considered')}">
                                ${getStatusLabel(paramData.status || 'not-considered')}
                            </span>
                        </div>
                        ${paramData.reason ? `<p class="text-sm text-blue-700 dark:text-blue-300 mt-2"><strong>Reason:</strong> ${paramData.reason}</p>` : ''}
                    </div>
                ` : ''}

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <p class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-1">Why this matters</p>
                    <p class="text-gray-700 dark:text-gray-300">${param.technicalNote}</p>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">Benefit Summary</h3>
                    <ul class="list-disc ml-5 text-gray-700 dark:text-gray-300">
                        ${param.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">Performance Levels</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-lg border border-green-200 dark:border-green-700">
                            <p class="text-sm font-semibold text-green-700 dark:text-green-300">Good</p>
                            <p class="text-lg font-bold text-green-800 dark:text-green-200">${param.optimal}</p>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg border border-yellow-200 dark:border-yellow-700">
                            <p class="text-sm font-semibold text-yellow-700 dark:text-yellow-300">OK</p>
                            <p class="text-lg font-bold text-yellow-800 dark:text-yellow-200">${param.acceptable}</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/30 p-3 rounded-lg border border-red-200 dark:border-red-700">
                            <p class="text-sm font-semibold text-red-700 dark:text-red-300">Risk</p>
                            <p class="text-lg font-bold text-red-800 dark:text-red-200">${param.risk}</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">Remediation Options</h3>
                    ${param.remediation.map(remedy => `
                        <div class="flex items-start mb-2">
                            <i data-lucide="check-circle" class="h-5 w-5 text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                            <p class="text-gray-700 dark:text-gray-300">${remedy}</p>
                        </div>
                    `).join('')}
                </div>

                <div>
                    <h3 class="font-semibold text-gray-800 dark:text-gray-100 mb-3">Impact Assessment</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="flex justify-center mb-2">
                                ${createImpactIndicator(param.impactScore.cost, 'cost')}
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Cost Impact</p>
                        </div>
                        <div class="text-center">
                            <div class="flex justify-center mb-2">
                                ${createImpactIndicator(param.impactScore.time, 'time')}
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Schedule Impact</p>
                        </div>
                        <div class="text-center">
                            <div class="flex justify-center mb-2">
                                ${createImpactIndicator(param.impactScore.carbon, 'carbon')}
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Carbon Impact</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailModal').classList.remove('hidden');
            initializeIcons();
        }

        // Initialize category filter
        function initializeCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="all">All Categories</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Switch view mode
        function switchViewMode(mode) {
            viewMode = mode;
            
            // Update button states
            document.querySelectorAll('.view-toggle').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-300');
            });
            
            if (mode === 'decision') {
                document.getElementById('quickRulesBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-300');
                document.getElementById('quickRulesBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('quickRulesView').classList.remove('hidden');
                document.getElementById('technicalView').classList.add('hidden');
                renderQuickRulesView();
            } else {
                document.getElementById('technicalViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-300');
                document.getElementById('technicalViewBtn').classList.add('bg-primary', 'text-white');
                document.getElementById('quickRulesView').classList.add('hidden');
                document.getElementById('technicalView').classList.remove('hidden');
                renderTechnicalView();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            showPage('input');
            initializeIcons();
            
            // Search input
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchTerm = e.target.value;
                if (viewMode === 'decision') {
                    renderQuickRulesView();
                } else {
                    renderTechnicalView();
                }
            });
            
            // Category filter
            document.getElementById('categoryFilter').addEventListener('change', function(e) {
                filterCategory = e.target.value;
                if (viewMode === 'decision') {
                    renderQuickRulesView();
                } else {
                    renderTechnicalView();
                }
            });
            
            // View toggle buttons
            document.getElementById('quickRulesBtn').addEventListener('click', () => switchViewMode('decision'));
            document.getElementById('technicalViewBtn').addEventListener('click', () => switchViewMode('technical'));
            
            // Modal close
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('detailModal').classList.add('hidden');
                selectedParameter = null;
            });
            
            // BIM Modal close
            document.getElementById('closeBimModal').addEventListener('click', function() {
                document.getElementById('bimModal').classList.add('hidden');
            });
            
            // Modal backdrop click
            document.getElementById('detailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                    selectedParameter = null;
                }
            });
            
            // BIM Modal backdrop click
            document.getElementById('bimModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });

        // Building Type Info Functions
        function toggleBuildingTypeInfo() {
            const popup = document.getElementById('buildingTypeInfo');
            popup.classList.toggle('hidden');
        }

        function showBuildingTypeInfo() {
            const popup = document.getElementById('buildingTypeInfo');
            popup.classList.remove('hidden');
        }

        function hideBuildingTypeInfo() {
            const popup = document.getElementById('buildingTypeInfo');
            popup.classList.add('hidden');
        }

        // Helper functions for simple mode
        function getSimpleStatusClass(status) {
            switch(status) {
                case 'optimal': return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
                case 'acceptable': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
                case 'risk': return 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300';
                default: return 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400';
            }
        }

        function getSimpleStatusIcon(status) {
            switch(status) {
                case 'optimal': return '✓';
                case 'acceptable': return '~';
                case 'risk': return '⚠';
                default: return '−';
            }
        }

        // Form efficiency calculation functions
        function toggleInputMode(paramId, mode) {
            const calculationBtn = document.getElementById(`mode-calculation-${paramId}`);
            const directBtn = document.getElementById(`mode-direct-${paramId}`);
            const calculationInputs = document.getElementById(`calculation-inputs-${paramId}`);
            const directInputs = document.getElementById(`direct-inputs-${paramId}`);
            
            if (mode === 'calculation') {
                calculationBtn.className = 'flex-1 px-2 py-1 text-xs rounded bg-primary text-white';
                directBtn.className = 'flex-1 px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300';
                calculationInputs.classList.remove('hidden');
                directInputs.classList.add('hidden');
            } else {
                calculationBtn.className = 'flex-1 px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300';
                directBtn.className = 'flex-1 px-2 py-1 text-xs rounded bg-primary text-white';
                calculationInputs.classList.add('hidden');
                directInputs.classList.remove('hidden');
            }
        }

        function calculateFormEfficiency(paramId) {
            const param = parameters.find(p => p.id === paramId);
            
            if (param.calculation) {
                const [input1Name, input2Name] = param.calculation.inputs;
                const input1 = document.getElementById(`${input1Name}-${paramId}`);
                const input2 = document.getElementById(`${input2Name}-${paramId}`);
                const resultInput = document.getElementById(`simple-input-${paramId}`);
                
                const value1 = parseFloat(input1.value) || 0;
                const value2 = parseFloat(input2.value) || 0;
                
                if (value1 > 0 && value2 > 0) {
                    let ratio;
                    if (param.calculation.formula === 'perimeter / area') {
                        ratio = value1 / value2;
                    } else if (param.calculation.formula === 'height / width') {
                        ratio = value1 / value2;
                    }
                    
                    resultInput.value = ratio.toFixed(3);
                    updateParameterValueSimple(paramId, ratio);
                } else {
                    resultInput.value = '';
                }
            }
        }

        // Exclude parameter function
        function excludeParameter(paramId) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            projectData.parameters[paramId].excluded = true;
            projectData.parameters[paramId].status = 'not-considered';
            renderParameterInputs();
        }

        // Enhanced parameter evaluation with range explanations
        function evaluateParameterStatusWithExplanation(param, value) {
            const status = evaluateParameterStatus(param, value);
            
            if (status === 'risk') {
                if (value > param.ranges.risk.max) {
                    return {
                        status: 'risk',
                        explanation: `Value significantly exceeds recommended limits. This may result in ${param.keyImpact}. Consider ${param.remediation[0] || 'reviewing design parameters'}.`
                    };
                } else if (value < param.ranges.optimal.min) {
                    return {
                        status: 'risk',
                        explanation: `Value is below optimal range. This could impact ${param.keyImpact}. Consider optimizing to achieve better performance.`
                    };
                }
                return {
                    status: 'risk',
                    explanation: `Value is in risk range. ${param.keyImpact}. Review ${param.remediation[0] || 'design parameters'}.`
                };
            }
            
            return { status, explanation: null };
        }

        // Update parameter value functions with explanations
        function updateParameterValueSimpleWithExplanation(paramId, value) {
            const param = parameters.find(p => p.id === paramId);
            const numValue = parseFloat(value);
            
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            
            projectData.parameters[paramId].value = numValue;
            const evaluation = evaluateParameterStatusWithExplanation(param, numValue);
            projectData.parameters[paramId].status = evaluation.status;
            projectData.parameters[paramId].explanation = evaluation.explanation;
            
            // Show explanation if value is out of range
            if (evaluation.explanation) {
                showRangeExplanation(paramId, evaluation.explanation);
            } else {
                hideRangeExplanation(paramId);
            }
        }

        function showRangeExplanation(paramId, explanation) {
            const existingExplanation = document.getElementById(`range-explanation-${paramId}`);
            if (existingExplanation) {
                existingExplanation.remove();
            }
            
            const paramSection = document.querySelector(`#simple-input-${paramId}`).closest('.space-y-2');
            if (paramSection) {
                const explanationDiv = document.createElement('div');
                explanationDiv.id = `range-explanation-${paramId}`;
                explanationDiv.className = 'bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded p-2 mt-2';
                explanationDiv.innerHTML = `
                    <div class="flex items-start gap-2">
                        <i data-lucide="alert-triangle" class="h-4 w-4 text-red-600 dark:text-red-400 mt-0.5 flex-shrink-0"></i>
                        <p class="text-xs text-red-700 dark:text-red-300">${explanation}</p>
                    </div>
                `;
                paramSection.appendChild(explanationDiv);
                initializeIcons();
            }
        }

        function hideRangeExplanation(paramId) {
            const existingExplanation = document.getElementById(`range-explanation-${paramId}`);
            if (existingExplanation) {
                existingExplanation.remove();
            }
        }

        // Show excluded parameters section
        function showExcludedParameters() {
            const excludedParams = parameters.filter(param => 
                projectData.parameters[param.id]?.excluded
            );
            
            if (excludedParams.length === 0) return '';
            
            return `
                <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Excluded Parameters (${excludedParams.length})</h4>
                        <button 
                            class="text-xs text-primary hover:text-primary/80 transition-colors"
                            onclick="toggleExcludedParameters()"
                        >
                            <span id="excluded-toggle-text">Show</span>
                        </button>
                    </div>
                    <div id="excluded-parameters-list" class="hidden space-y-2">
                        ${excludedParams.map(param => `
                            <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-600 rounded">
                                <span class="text-sm text-gray-700 dark:text-gray-300">${param.parameter}</span>
                                <button 
                                    class="text-xs text-green-600 hover:text-green-700 transition-colors"
                                    onclick="includeParameter('${param.id}')"
                                >
                                    Include
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function toggleExcludedParameters() {
            const list = document.getElementById('excluded-parameters-list');
            const toggleText = document.getElementById('excluded-toggle-text');
            
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                toggleText.textContent = 'Hide';
            } else {
                list.classList.add('hidden');
                toggleText.textContent = 'Show';
            }
        }

        function includeParameter(paramId) {
            if (projectData.parameters[paramId]) {
                delete projectData.parameters[paramId].excluded;
            }
            renderParameterInputs();
        }

        // Toggle parameter comment function for out-of-range values
        function toggleParameterComment(paramId) {
            const existingComment = document.getElementById(`comment-section-${paramId}`);
            
            if (existingComment) {
                existingComment.remove();
                return;
            }
            
            const paramContainer = document.getElementById(`param-container-${paramId}`);
            if (paramContainer) {
                const commentSection = document.createElement('div');
                commentSection.id = `comment-section-${paramId}`;
                commentSection.className = 'mt-2 p-3 bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-700 rounded-lg';
                commentSection.innerHTML = `
                    <div class="flex items-start gap-2 mb-2">
                        <i data-lucide="message-circle" class="h-4 w-4 text-orange-600 dark:text-orange-400 mt-0.5 flex-shrink-0"></i>
                        <label class="text-xs font-medium text-orange-800 dark:text-orange-200">
                            Comment on out-of-range value:
                        </label>
                    </div>
                    <textarea 
                        id="comment-${paramId}"
                        rows="2"
                        placeholder="Explain why this value is beyond expected range or provide additional context..."
                        class="w-full px-2 py-1 border border-orange-300 dark:border-orange-600 rounded text-xs bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-orange-500 focus:border-transparent"
                        onchange="updateParameterComment('${paramId}', this.value)"
                    >${projectData.parameters[paramId]?.comment || ''}</textarea>
                    <div class="flex justify-end mt-2">
                        <button 
                            onclick="toggleParameterComment('${paramId}')"
                            class="text-xs text-orange-600 hover:text-orange-700 transition-colors"
                        >
                            Close
                        </button>
                    </div>
                `;
                paramContainer.appendChild(commentSection);
                initializeIcons();
            }
        }

        // Update parameter comment function
        function updateParameterComment(paramId, comment) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            projectData.parameters[paramId].comment = comment;
        }

        // Exclude/Include parameter functions
        function excludeParameterFromAnalysis(paramId) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            projectData.parameters[paramId].minimized = true;
            projectData.parameters[paramId].status = 'not-considered';
            renderParameterInputs();
        }

        function includeParameterInAnalysis(paramId) {
            if (!projectData.parameters[paramId]) {
                projectData.parameters[paramId] = {};
            }
            projectData.parameters[paramId].minimized = false;
            
            // Reset to default value and re-evaluate
            const param = parameters.find(p => p.id === paramId);
            const value = projectData.parameters[paramId].value || param.defaultValue;
            projectData.parameters[paramId].value = value;
            projectData.parameters[paramId].status = evaluateParameterStatus(param, value);
            
            renderParameterInputs();
        }

        // BIM Integration Functions
        function showBIMIntegration() {
            document.getElementById('bimModal').classList.remove('hidden');
        }

        function closeBIMIntegration() {
            document.getElementById('bimModal').classList.add('hidden');
        }

        // Global functions for onclick handlers
        window.showPage = showPage;
        window.showParameterDetail = showParameterDetail;
        window.proceedToAnalysis = proceedToAnalysis;
        window.proceedToSummary = proceedToSummary;
        window.updateParameterValue = updateParameterValue;
        window.updateParameterValueSimple = updateParameterValueSimpleWithExplanation;
        window.toggleParameterConsideration = toggleParameterConsideration;
        window.updateParameterReason = updateParameterReason;
        window.useOptimalValue = useOptimalValue;
        window.useOptimalValueSimple = useOptimalValueSimple;
        window.exportToPDF = exportToPDF;
        window.exportToCSV = exportToCSV;
        window.generatePresentation = generatePresentation;
        window.resetTool = resetTool;
        window.toggleParameterInfo = toggleParameterInfo;
        window.toggleBuildingTypeInfo = toggleBuildingTypeInfo;
        window.showBuildingTypeInfo = showBuildingTypeInfo;
        window.hideBuildingTypeInfo = hideBuildingTypeInfo;
        window.switchInputMode = switchInputMode;
        window.toggleParameterExpansion = toggleParameterExpansion;
        window.removeParameterFromConsideration = removeParameterFromConsideration;
        window.toggleInputMode = toggleInputMode;
        window.calculateFormEfficiency = calculateFormEfficiency;
        window.excludeParameter = excludeParameter;
        window.toggleExcludedParameters = toggleExcludedParameters;
        window.includeParameter = includeParameter;
        window.toggleParameterMinimize = toggleParameterMinimize;
        window.updateParameterExplanation = updateParameterExplanation;
        window.toggleParameterComment = toggleParameterComment;
        window.updateParameterComment = updateParameterComment;
        window.excludeParameterFromAnalysis = excludeParameterFromAnalysis;
        window.includeParameterInAnalysis = includeParameterInAnalysis;
        window.showBIMIntegration = showBIMIntegration;
        window.closeBIMIntegration = closeBIMIntegration;

        // Close info popups when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.info-button') && !e.target.closest('.info-popup')) {
                document.querySelectorAll('.info-popup').forEach(popup => {
                    popup.classList.add('hidden');
                });
            }
        });
    </script>
</body>
</html>
